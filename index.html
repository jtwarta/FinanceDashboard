<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ledger of the Realm — Personal Finance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=IM+Fell+English:ital@0;1&family=Sedan+SC&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            parchment: {
              50: '#fdfcfa',
              100: '#f9f7f3',
              200: '#f4f1eb',
              300: '#ebe6dc',
              400: '#d9d0c1',
              500: '#c4b8a5',
              600: '#9a8b76',
              700: '#6b5d4d',
              800: '#4a3f33',
              900: '#2d261e'
            },
            ink: {
              DEFAULT: '#1a1612',
              light: '#3d352c',
              faded: '#5c5347'
            }
          },
          fontFamily: {
            cinzel: ['Cinzel', 'serif'],
            fell: ['IM Fell English', 'serif'],
            sedan: ['Sedan SC', 'serif']
          }
        }
      }
    }
  </script>
  <style>
    body { 
      background: #1a1612;
      font-family: 'IM Fell English', serif;
    }

```
.parchment-bg {
  background-color: #f7f4ef;
  background-image: 
    radial-gradient(ellipse at 8% 15%, rgba(139, 115, 85, 0.04) 0%, transparent 40%),
    radial-gradient(ellipse at 92% 80%, rgba(120, 100, 75, 0.03) 0%, transparent 35%),
    linear-gradient(180deg, #f9f7f3 0%, #f7f4ef 30%, #f5f2ec 70%, #f7f4ef 100%);
}

.parchment-texture::before {
  content: '';
  position: absolute;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
  opacity: 0.02;
  pointer-events: none;
}

.ink {
  color: #1a1612;
}

.ink-faded {
  color: #5c5347;
}

.scroll-section {
  position: relative;
  background: rgba(255, 255, 255, 0.4);
  border: 1px solid #c4b8a5;
  border-radius: 2px;
}

.scroll-card {
  background: rgba(255, 255, 255, 0.5);
  border: 1px solid #c4b8a5;
  border-radius: 2px;
}

.wax-seal {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 50px;
  height: 50px;
  background: radial-gradient(circle at 35% 35%, #8b4a4a 0%, #6b3a3a 50%, #4a2828 100%);
  border-radius: 50%;
  box-shadow: inset -2px -2px 4px rgba(0,0,0,0.3), inset 1px 1px 3px rgba(255,255,255,0.1), 0 2px 6px rgba(0,0,0,0.3);
  font-family: 'Cinzel', serif;
  color: rgba(255,255,255,0.12);
  font-size: 22px;
  font-weight: 700;
}

.divider-ornate {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  color: #9a8b76;
}
.divider-ornate::before,
.divider-ornate::after {
  content: '';
  flex: 1;
  height: 1px;
  background: linear-gradient(90deg, transparent, #c4b8a5 20%, #c4b8a5 80%, transparent);
}

.drop-cap {
  float: left;
  font-family: 'Cinzel', serif;
  font-size: 2.8rem;
  line-height: 0.85;
  padding-right: 8px;
  padding-top: 2px;
  color: #1a1612;
}

.stat-card {
  background: rgba(255, 255, 255, 0.3);
  border: 1px solid #d9d0c1;
  border-radius: 2px;
}

.stat-card-accent {
  background: rgba(255, 255, 255, 0.4);
  border: 1px solid #9a8b76;
  border-radius: 2px;
}

.tooltip-wrapper {
  position: relative;
}
.tooltip-content {
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: #f9f7f3;
  border: 1px solid #9a8b76;
  border-radius: 2px;
  padding: 12px 16px;
  min-width: 200px;
  max-width: 280px;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s, visibility 0.2s;
  z-index: 50;
  box-shadow: 0 4px 20px rgba(26, 22, 18, 0.15);
}
.tooltip-content::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: #9a8b76;
}
.tooltip-wrapper:hover .tooltip-content {
  opacity: 1;
  visibility: visible;
}
.tooltip-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 3px 0;
  border-bottom: 1px solid #ebe6dc;
}
.tooltip-row:last-child {
  border-bottom: none;
}
.tooltip-title {
  font-family: 'Cinzel', serif;
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #4a3f33;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 1px solid #d9d0c1;
}

.btn {
  background: rgba(255, 255, 255, 0.5);
  border: 1px solid #c4b8a5;
  color: #1a1612;
  transition: all 0.2s;
  border-radius: 2px;
}
.btn:hover {
  background: rgba(255, 255, 255, 0.7);
  border-color: #9a8b76;
}

.status-good {
  background: #5a7a5a;
  box-shadow: 0 0 4px rgba(90, 122, 90, 0.5);
}
.status-bad {
  background: #7a5a5a;
  box-shadow: 0 0 4px rgba(122, 90, 90, 0.5);
}

.tag {
  font-size: 9px;
  padding: 2px 8px;
  border-radius: 2px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.tag-historical {
  background: rgba(90, 122, 90, 0.15);
  color: #4a5a4a;
  border: 1px solid rgba(90, 122, 90, 0.3);
}
.tag-projected {
  background: rgba(122, 100, 70, 0.15);
  color: #5a4a3a;
  border: 1px solid rgba(122, 100, 70, 0.3);
}

h1, h2, h3 {
  font-family: 'Cinzel', serif;
  color: #1a1612;
}

.label {
  font-family: 'Cinzel', serif;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: #5c5347;
}

.value-large {
  font-family: 'IM Fell English', serif;
  font-size: 1.5rem;
  color: #1a1612;
}

.value-xl {
  font-family: 'Cinzel', serif;
  font-size: 3.5rem;
  font-weight: 700;
  color: #1a1612;
}

.positive { color: #4a5a4a; }
.negative { color: #6a4a4a; }

.panel {
  background: rgba(255, 255, 255, 0.25);
  border: 1px solid #d9d0c1;
  border-radius: 2px;
}
.panel-header {
  padding: 12px 16px;
  cursor: pointer;
  transition: background 0.2s;
}
.panel-header:hover {
  background: rgba(255, 255, 255, 0.3);
}
.panel-content {
  border-top: 1px solid #d9d0c1;
  padding: 16px;
  background: rgba(255, 255, 255, 0.2);
}

.data-table {
  width: 100%;
  font-size: 13px;
}
.data-table th {
  font-family: 'Cinzel', serif;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #5c5347;
  padding: 8px 6px;
  text-align: right;
  border-bottom: 1px solid #d9d0c1;
}
.data-table th:first-child {
  text-align: left;
}
.data-table td {
  padding: 6px;
  text-align: right;
  border-bottom: 1px solid #ebe6dc;
  color: #1a1612;
}
.data-table td:first-child {
  text-align: left;
  font-weight: 500;
}
.data-table tr.highlight {
  background: rgba(90, 122, 90, 0.08);
}
.data-table tr.milestone {
  background: rgba(122, 100, 70, 0.08);
}
```

  </style>
</head>
<body class="min-h-screen">
  <div class="fixed inset-0 parchment-bg parchment-texture"></div>
  <div class="fixed inset-6 pointer-events-none border border-parchment-400/40 rounded"></div>

  <div class="fixed top-8 left-8 text-parchment-500/30 text-2xl pointer-events-none font-serif">❧</div>
  <div class="fixed top-8 right-8 text-parchment-500/30 text-2xl pointer-events-none font-serif" style="transform: scaleX(-1);">❧</div>
  <div class="fixed bottom-8 left-8 text-parchment-500/30 text-2xl pointer-events-none font-serif" style="transform: scaleY(-1);">❧</div>
  <div class="fixed bottom-8 right-8 text-parchment-500/30 text-2xl pointer-events-none font-serif" style="transform: scale(-1);">❧</div>

  <div id="app" class="relative max-w-4xl mx-auto px-8 py-10">

```
<header class="relative mb-8">
  <div class="absolute -top-1 -right-1 wax-seal z-10"><span>L</span></div>

  <div class="scroll-card p-6 pr-20">
    <h1 class="text-2xl font-semibold font-cinzel tracking-wide">Ledger of the Realm</h1>
    <p class="ink-faded text-sm italic mt-1">A Chronicle of Wealth & Fortune</p>
    <p id="lastDate" class="ink-faded text-xs mt-2"></p>
    
    <div class="absolute top-4 right-16 flex flex-col items-end gap-2">
      <span id="fetchTime" class="text-xs ink-faded"></span>
      <button onclick="loadData()" id="refreshBtn" class="btn flex items-center gap-2 px-3 py-1.5 text-sm">
        <svg id="refreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        Refresh
      </button>
    </div>
  </div>
</header>

<div class="divider-ornate mb-8">
  <span class="font-cinzel text-xs tracking-widest ink-faded">ANNO DOMINI MMXXVI</span>
</div>

<div class="scroll-card p-4 mb-8">
  <div class="grid grid-cols-2 gap-6 mb-3">
    <div>
      <p class="label">Bitcoin</p>
      <p id="btcLivePrice" class="value-large">Loading...</p>
      <p id="btcChange" class="text-xs ink-faded">--</p>
    </div>
    <div class="text-right">
      <p class="label">S&P 500</p>
      <p id="spLivePrice" class="value-large">Loading...</p>
      <p id="spChange" class="text-xs ink-faded">--</p>
    </div>
  </div>
  <div style="height: 70px; position: relative;">
    <canvas id="marketSparkline"></canvas>
  </div>
  <p class="text-[10px] ink-faded text-center mt-1">90-day performance comparison</p>
</div>

<div id="loading" class="flex justify-center py-16">
  <div class="w-8 h-8 rounded-full border border-parchment-600 border-t-transparent animate-spin"></div>
</div>

<div id="error" class="hidden scroll-card p-6 text-center">
  <p class="font-cinzel text-lg mb-2">The Scroll Could Not Be Read</p>
  <p id="errorMsg" class="text-sm ink-faded mb-4"></p>
  <button onclick="loadData()" class="btn px-4 py-2">Retry</button>
</div>

<div id="content" class="hidden space-y-10">
  
  <section class="scroll-section p-6">
    <div class="flex items-center gap-3 mb-6">
      <span class="drop-cap">N</span>
      <div>
        <h2 class="text-xl font-semibold">et Worth Overview</h2>
        <p class="text-sm ink-faded italic">Treasury of the Household</p>
      </div>
    </div>

    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="stat-card-accent p-4">
        <p class="label">Net Worth</p>
        <p id="netWorth" class="value-large font-semibold">-</p>
        <p id="netWorthBTC" class="text-xs ink-faded"></p>
        <p id="netWorthTrend" class="text-xs mt-1"></p>
      </div>
      <div class="stat-card p-4">
        <p class="label">Total Assets</p>
        <p id="totalAssets" class="value-large">-</p>
        <p id="assetsTrend" class="text-xs mt-1"></p>
      </div>
      <div class="stat-card p-4">
        <p class="label">Total Liabilities</p>
        <p id="totalLiab" class="value-large">-</p>
        <p id="liabTrend" class="text-xs mt-1"></p>
      </div>
      <div class="stat-card p-4">
        <p class="label">BTC Stack</p>
        <p id="btcStack" class="value-large">-</p>
        <p id="btcPrice" class="text-xs ink-faded"></p>
        <p id="btcTrend" class="text-xs mt-1"></p>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="stat-card p-4">
        <p class="label">Jon</p>
        <p id="jonNW" class="value-large">-</p>
      </div>
      <div class="stat-card p-4">
        <p class="label">Lenora</p>
        <p id="lenoraNW" class="value-large">-</p>
      </div>
    </div>

    <div class="stat-card p-4 mb-6">
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-cinzel text-sm">Net Worth History</h3>
        <span class="tag tag-historical">historical</span>
      </div>
      <p class="text-xs ink-faded mb-2">
        <span class="inline-block w-8 border-t-2 border-parchment-700 mr-1 align-middle"></span> USD
        <span class="inline-block w-8 border-t-2 border-parchment-500 border-dashed ml-3 mr-1 align-middle"></span> BTC
      </p>
      <div style="height: 180px; position: relative;">
        <canvas id="nwChart"></canvas>
      </div>
    </div>

    <div class="grid grid-cols-3 lg:grid-cols-6 gap-3 mb-4">
      <div class="stat-card p-3 text-center">
        <p class="label text-[9px]">Home</p>
        <p id="homeVal" class="text-lg">-</p>
      </div>
      <div class="stat-card p-3 text-center">
        <p class="label text-[9px]">IRA</p>
        <p id="iraVal" class="text-lg">-</p>
      </div>
      <div class="stat-card p-3 text-center">
        <p class="label text-[9px]">Bitcoin</p>
        <p id="btcVal" class="text-lg">-</p>
      </div>
      <div class="stat-card p-3 text-center">
        <p class="label text-[9px]">Cash</p>
        <p id="cashVal" class="text-lg">-</p>
      </div>
      <div class="stat-card p-3 text-center">
        <p class="label text-[9px]">Cars</p>
        <p id="carsVal" class="text-lg">-</p>
      </div>
      <div class="stat-card p-3 text-center">
        <p class="label text-[9px]">Home Equity</p>
        <p id="homeEqVal" class="text-lg">-</p>
      </div>
    </div>

    <div class="grid grid-cols-3 gap-3">
      <div class="stat-card p-3 text-center">
        <p class="label text-[9px]">Mortgage</p>
        <p id="mortgageVal" class="text-lg">-</p>
      </div>
      <div id="helocCard" class="stat-card p-3 text-center">
        <p class="label text-[9px]">HELOC</p>
        <p id="helocVal" class="text-lg">-</p>
      </div>
      <div id="studentCard" class="stat-card p-3 text-center">
        <p class="label text-[9px]">Student Loans</p>
        <p id="studentVal" class="text-lg">-</p>
      </div>
    </div>
  </section>

  <div class="divider-ornate">
    <span class="text-parchment-500">✦</span>
  </div>

  <section class="scroll-section p-6">
    <div class="flex items-center gap-3 mb-6">
      <span class="drop-cap">F</span>
      <div>
        <h2 class="text-xl font-semibold">inancial Independence</h2>
        <p class="text-sm ink-faded italic">The Path to Freedom</p>
      </div>
      <span class="tag tag-projected ml-auto">projection</span>
    </div>

    <div class="stat-card-accent p-6 mb-6 text-center">
      <p class="label mb-2">Year of Independence</p>
      <p id="retireHeroYear" class="value-xl">--</p>
      <p class="ink-faded mt-1">
        <span id="retireYears" class="font-semibold">--</span> years hence
      </p>
    </div>

    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="stat-card p-4 text-center">
        <p class="label">Current NW</p>
        <p id="retireCurrentNW" class="value-large">-</p>
        <p class="text-xs ink-faded">live data</p>
      </div>
      <div class="stat-card p-4 text-center">
        <p class="label">Target NW</p>
        <p id="retireTarget" class="value-large">-</p>
        <p class="text-xs ink-faded">35× expenses</p>
      </div>
      <div class="stat-card p-4 text-center">
        <p class="label">Target Year</p>
        <p id="retireTargetYear" class="value-large">-</p>
        <p class="text-xs ink-faded">NW ≥ Required</p>
      </div>
      <div class="tooltip-wrapper stat-card p-4 text-center cursor-help">
        <p class="label">Pension (Est.)</p>
        <p id="pensionMonthly" class="value-large">$3,000/mo</p>
        <p class="text-xs ink-faded">starts age 65</p>
        <div class="tooltip-content" style="min-width: 220px;">
          <div class="tooltip-title">Kaiser Pension</div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">Monthly Benefit</span>
            <span class="text-sm ink">$3,000</span>
          </div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">Annual Income</span>
            <span class="text-sm ink">$36,000</span>
          </div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">Benefits Start</span>
            <span class="text-sm ink">Age 65 (2054)</span>
          </div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">Portfolio Offset</span>
            <span class="text-sm positive">−$1.26M</span>
          </div>
          <p class="text-[10px] ink-faded mt-2 italic">Conservative estimate. Actual may be higher.</p>
        </div>
      </div>
    </div>

    <div class="stat-card p-4 mb-6">
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-cinzel text-sm">Net Worth Projection</h3>
        <span class="tag tag-projected">projected</span>
      </div>
      <p class="text-xs ink-faded mb-2">
        <span class="inline-block w-6 h-2 bg-parchment-700/50 mr-1 align-middle rounded-sm"></span> Projected NW
        <span class="inline-block w-6 border-t border-dashed border-parchment-600 ml-3 mr-1 align-middle"></span> Required (35×)
        <span class="text-[10px] ml-3">★ 2035 loans forgiven</span>
      </p>
      <div style="height: 200px; position: relative;">
        <canvas id="retireChart"></canvas>
      </div>
    </div>

    <div class="space-y-3">
      <div class="panel">
        <div onclick="toggleRetireSection('assumptions')" class="panel-header flex items-center justify-between">
          <span class="text-sm font-medium flex items-center gap-2">
            <svg class="w-4 h-4 ink-faded" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
            Model Assumptions
          </span>
          <svg id="assumptionsChevron" class="w-4 h-4 ink-faded transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
        <div id="assumptionsContent" class="hidden panel-content">
          <div class="grid grid-cols-2 lg:grid-cols-3 gap-6 text-sm ink">
            <div>
              <p class="label mb-2">Asset Growth</p>
              <p>BTC: 10%/yr</p>
              <p>IRAs: 8%/yr</p>
              <p>Home: 5%/yr</p>
              <p class="ink-faded">Cars: −10%/yr</p>
            </div>
            <div>
              <p class="label mb-2">Inflation Model</p>
              <p>Variable expenses: 6%/yr</p>
              <p>Mortgage: Fixed (3.25%)</p>
              <p>Salary: Jon 3%, Lenora 5%</p>
            </div>
            <div>
              <p class="label mb-2">Expense Breakdown</p>
              <p>Total: $118,301/yr</p>
              <p>Fixed (mortgage): $38,268/yr</p>
              <p>Variable: $80,033/yr</p>
            </div>
            <div>
              <p class="label mb-2">Portfolio Rule</p>
              <p>Base: 30× expenses</p>
              <p>Tax adjusted: 35×</p>
              <p class="text-xs ink-faded italic">Roth + traditional mix</p>
            </div>
            <div>
              <p class="label mb-2">Key Milestones</p>
              <p class="positive">HELOC: Paid Sept 2026</p>
              <p>Student Loans: Forgiven 2035</p>
              <p class="text-xs ink-faded italic">Lenora PSLF Year 20</p>
            </div>
            <div>
              <p class="label mb-2">Kaiser Pension</p>
              <p>Estimate: $3,000/mo</p>
              <p>Benefits start: Age 65</p>
              <p class="positive">Portfolio offset: −$1.26M</p>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div onclick="toggleRetireSection('yearByYear')" class="panel-header flex items-center justify-between">
          <span class="text-sm font-medium flex items-center gap-2">
            <svg class="w-4 h-4 ink-faded" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Year-by-Year Projection
          </span>
          <svg id="yearByYearChevron" class="w-4 h-4 ink-faded transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
        <div id="yearByYearContent" class="hidden panel-content overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th class="text-left">Year</th>
                <th>Start NW</th>
                <th>Savings</th>
                <th>Growth</th>
                <th>End NW</th>
                <th>Expenses</th>
                <th>Required</th>
                <th>Gap</th>
              </tr>
            </thead>
            <tbody id="yearByYearTable"></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <div onclick="toggleRetireSection('savings')" class="panel-header flex items-center justify-between">
          <span class="text-sm font-medium flex items-center gap-2">
            <svg class="w-4 h-4 ink-faded" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            Monthly Savings by Year
          </span>
          <svg id="savingsChevron" class="w-4 h-4 ink-faded transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
        <div id="savingsContent" class="hidden panel-content overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th class="text-left">Year</th>
                <th>BTC Purchases</th>
                <th>IRA + Match</th>
                <th>Monthly Total</th>
                <th>Annual Total</th>
              </tr>
            </thead>
            <tbody id="savingsTable"></tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <div onclick="toggleRetireSection('assetGrowth')" class="panel-header flex items-center justify-between">
          <span class="text-sm font-medium flex items-center gap-2">
            <svg class="w-4 h-4 ink-faded" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
            </svg>
            Asset Growth Over Time
          </span>
          <svg id="assetGrowthChevron" class="w-4 h-4 ink-faded transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
        <div id="assetGrowthContent" class="hidden panel-content overflow-x-auto">
          <table class="data-table">
            <thead>
              <tr>
                <th class="text-left">Year</th>
                <th>Home Equity</th>
                <th>IRAs</th>
                <th>Bitcoin</th>
                <th>Cars + Cash</th>
                <th>Student Loans</th>
                <th>Total NW</th>
              </tr>
            </thead>
            <tbody id="assetGrowthTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <div class="divider-ornate">
    <span class="text-parchment-500">✦</span>
  </div>

  <section class="scroll-section p-6">
    <div class="flex items-center gap-3 mb-6">
      <span class="drop-cap">C</span>
      <div>
        <h2 class="text-xl font-semibold">ash Flow</h2>
        <p class="text-sm ink-faded italic">Ledger of Commerce <span id="cfYear" class="font-medium"></span></p>
      </div>
    </div>

    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
      <div class="tooltip-wrapper stat-card p-4 cursor-help">
        <p class="label">Gross Income</p>
        <p id="grossIncome" class="value-large">-</p>
        <p class="text-xs ink-faded">monthly avg</p>
        <div class="tooltip-content">
          <div class="tooltip-title">Gross Income Breakdown</div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">Jon's Salary</span>
            <span id="ttJonSalary" class="text-sm ink">-</span>
          </div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">Lenora's Salary</span>
            <span id="ttLenoraSalary" class="text-sm ink">-</span>
          </div>
        </div>
      </div>
      
      <div class="tooltip-wrapper stat-card p-4 cursor-help">
        <p class="label">Take-Home</p>
        <p id="takeHome" class="value-large">-</p>
        <p class="text-xs ink-faded">monthly avg</p>
        <div class="tooltip-content">
          <div class="tooltip-title">Take-Home Breakdown</div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">Gross Income</span>
            <span id="ttGrossForTakeHome" class="text-sm ink">-</span>
          </div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">Federal Tax</span>
            <span id="ttFedTaxTakeHome" class="text-sm negative">-</span>
          </div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">State Tax</span>
            <span id="ttStateTaxTakeHome" class="text-sm negative">-</span>
          </div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">IRA Contributions</span>
            <span id="ttIRATakeHome" class="text-sm ink">-</span>
          </div>
          <div class="tooltip-row" style="border-top: 1px solid #d9d0c1; margin-top: 4px; padding-top: 8px;">
            <span class="text-xs font-medium ink">Net Take-Home</span>
            <span id="ttNetTakeHome" class="text-sm font-medium ink">-</span>
          </div>
        </div>
      </div>

      <div class="tooltip-wrapper stat-card p-4 cursor-help">
        <p class="label">Taxes</p>
        <p id="monthlyTax" class="value-large">-</p>
        <p id="taxRate" class="text-xs ink-faded"></p>
        <div class="tooltip-content">
          <div class="tooltip-title">Tax Breakdown (2024)</div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">Federal Tax</span>
            <span id="ttFedTax" class="text-sm ink">-</span>
          </div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">State Tax (CA)</span>
            <span id="ttStateTax" class="text-sm ink">-</span>
          </div>
          <div class="tooltip-row" style="border-top: 1px solid #d9d0c1; margin-top: 4px; padding-top: 8px;">
            <span class="text-xs font-medium ink">Total Monthly</span>
            <span id="ttTotalTax" class="text-sm font-medium ink">-</span>
          </div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">Effective Rate</span>
            <span id="ttTaxRate" class="text-sm ink">-</span>
          </div>
        </div>
      </div>

      <div class="tooltip-wrapper stat-card p-4 cursor-help">
        <p class="label">Expenses</p>
        <p id="expenses" class="value-large">-</p>
        <p class="text-xs ink-faded">monthly avg</p>
        <div class="tooltip-content">
          <div class="tooltip-title">Top Expenses</div>
          <div id="expensesTooltip"></div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-3 gap-4 mb-6">
      <div class="tooltip-wrapper stat-card p-4 cursor-help">
        <p class="label">Net Inflow</p>
        <p id="netInflow" class="value-large">-</p>
        <p class="text-xs ink-faded">monthly avg</p>
        <div class="tooltip-content">
          <div class="tooltip-title">Net Inflow Calculation</div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">Take-Home Pay</span>
            <span id="ttTakeHomeForInflow" class="text-sm positive">-</span>
          </div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">Total Expenses</span>
            <span id="ttExpensesForInflow" class="text-sm negative">-</span>
          </div>
          <div class="tooltip-row" style="border-top: 1px solid #d9d0c1; margin-top: 4px; padding-top: 8px;">
            <span class="text-xs font-medium ink">Net Inflow</span>
            <span id="ttNetInflow" class="text-sm font-medium ink">-</span>
          </div>
        </div>
      </div>

      <div class="tooltip-wrapper stat-card p-4 cursor-help">
        <p class="label">Total Savings</p>
        <p id="totalSavings" class="value-large">-</p>
        <p class="text-xs ink-faded">monthly avg</p>
        <div class="tooltip-content">
          <div class="tooltip-title">Savings Breakdown</div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">BTC Purchases</span>
            <span id="ttBTCSavings" class="text-sm ink">-</span>
          </div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">IRA + Match</span>
            <span id="ttIRASavings" class="text-sm ink">-</span>
          </div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">Home Equity Added</span>
            <span id="ttHomeEquity" class="text-sm ink">-</span>
          </div>
          <div class="tooltip-row" style="border-top: 1px solid #d9d0c1; margin-top: 4px; padding-top: 8px;">
            <span class="text-xs font-medium ink">Total Monthly</span>
            <span id="ttTotalSavings" class="text-sm font-medium ink">-</span>
          </div>
        </div>
      </div>

      <div class="tooltip-wrapper stat-card p-4 cursor-help">
        <p class="label">Free Cash</p>
        <p id="freeCash" class="value-large">-</p>
        <p class="text-xs ink-faded">after savings</p>
        <div class="tooltip-content">
          <div class="tooltip-title">Free Cash Calculation</div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">Net Inflow</span>
            <span id="ttInflowForFree" class="text-sm ink">-</span>
          </div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">BTC Purchases</span>
            <span id="ttBTCForFree" class="text-sm negative">-</span>
          </div>
          <div class="tooltip-row">
            <span class="text-xs ink-faded">Utility Bills</span>
            <span id="ttBillsForFree" class="text-sm negative">-</span>
          </div>
          <div class="tooltip-row" style="border-top: 1px solid #d9d0c1; margin-top: 4px; padding-top: 8px;">
            <span class="text-xs font-medium ink">Discretionary</span>
            <span id="ttFreeCash" class="text-sm font-medium ink">-</span>
          </div>
        </div>
      </div>
    </div>

    <div class="stat-card p-4">
      <h3 class="font-cinzel text-sm mb-3">Monthly Bills</h3>
      <div style="height: 180px; position: relative;">
        <canvas id="billsChart"></canvas>
      </div>
    </div>
  </section>

  <div class="divider-ornate mt-10 mb-6">
    <span class="text-parchment-500">❧</span>
    <span class="font-cinzel text-xs tracking-widest ink-faded">FINIS</span>
    <span class="text-parchment-500">❧</span>
  </div>

  <div class="scroll-card p-4 flex items-center justify-between">
    <div class="flex gap-6">
      <div class="flex items-center gap-2">
        <div id="nwStatus" class="w-2 h-2 rounded-full status-good"></div>
        <span class="text-xs ink-faded">Treasury Scroll</span>
      </div>
      <div class="flex items-center gap-2">
        <div id="cfStatus" class="w-2 h-2 rounded-full status-good"></div>
        <span class="text-xs ink-faded">Commerce Scroll</span>
      </div>
    </div>
    <p class="text-xs ink-faded italic">Inscribed by enchanted quill</p>
  </div>
</div>
```

  </div>

  <script src="https://script.google.com/macros/s/AKfycbwNpO22WV5YDDcVNBj_tmcpulFqh1koLjiSylo4M_GLZENsfZCPujAvQWB7m-_YhyK-/exec"></script>

  <script>
    const API = {
      netWorth: 'https://script.google.com/macros/s/AKfycbwNpO22WV5YDDcVNBj_tmcpulFqh1koLjiSylo4M_GLZENsfZCPujAvQWB7m-_YhyK-/exec',
      cashFlow: 'https://script.google.com/macros/s/AKfycbz8PFG22RExCfmgzvdvU2z-qeMiTYfXNiwfQ_K_0TmvWav-n5ucP8u_l5yZU-iW9GOUSw/exec'
    };

    const COLORS = { primary: '#1a1612', secondary: '#5c5347', light: '#9a8b76', grid: 'rgba(26, 22, 18, 0.08)' };

    async function loadMarketData() {
      try {
        const btcRes = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true');
        const btcData = await btcRes.json();
        const btcPrice = btcData.bitcoin.usd;
        document.getElementById('btcLivePrice').textContent = `$${btcPrice.toLocaleString()}`;
        document.getElementById('btcChange').textContent = '+34.3% (90d)';
      } catch (e) {
        document.getElementById('btcLivePrice').textContent = '$89,944';
        document.getElementById('btcChange').textContent = '+34.3% (90d)';
      }
      document.getElementById('spLivePrice').textContent = '6,876';
      document.getElementById('spChange').textContent = '+12.7% (90d)';
      drawSparklines();
    }

    function drawSparklines() {
      const btcData = [67000, 72000, 78000, 85000, 92000, 99000, 95000, 88000, 82000, 78000, 80000, 82000, 84000, 86000, 88000, 89000, 90000, 90000];
      const spData = [6100, 6150, 6200, 6280, 6350, 6400, 6450, 6500, 6550, 6520, 6580, 6620, 6680, 6720, 6780, 6820, 6850, 6876];
      const canvas = document.getElementById('marketSparkline');
      const ctx = canvas.getContext('2d');
      const width = canvas.parentElement.clientWidth;
      canvas.width = width;
      canvas.height = 70;
      ctx.clearRect(0, 0, width, 70);
      drawSparkline(ctx, btcData, COLORS.primary, width, 70, 2);
      drawSparkline(ctx, spData, COLORS.light, width, 70, 1.5);
    }

    function drawSparkline(ctx, data, color, width, height, lineWidth) {
      const padding = 8, w = width - padding * 2, h = height - padding * 2;
      const min = Math.min(...data) * 0.95, max = Math.max(...data) * 1.05, range = max - min;
      ctx.beginPath();
      ctx.strokeStyle = color;
      ctx.lineWidth = lineWidth;
      data.forEach((val, i) => {
        const x = padding + (i / (data.length - 1)) * w;
        const y = padding + h - ((val - min) / range) * h;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    let nwChart = null, billsChart = null, retireChart = null;

    const fmt = (v, compact) => {
      if (v == null || v === '' || isNaN(v)) return '$0';
      const n = typeof v === 'string' ? parseFloat(v.replace(/[$,]/g, '')) : v;
      if (compact && Math.abs(n) >= 1e6) return `$${(n/1e6).toFixed(2)}M`;
      if (compact && Math.abs(n) >= 1e3) return `$${(n/1e3).toFixed(0)}K`;
      return n.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
    };

    const fmtBTC = v => v ? `${parseFloat(v).toFixed(4)} BTC` : '0 BTC';
    const fmtDate = d => d ? new Date(d).toLocaleDateString('en-US', { month: 'short', year: '2-digit' }) : '';

    const parseNW = raw => {
      if (!raw?.sheets?.['Net Worth USD/BTC']) return null;
      const rows = raw.sheets['Net Worth USD/BTC'];
      const dates = rows[0].slice(2);
      const last = dates.length - 1;
      const get = (r, c = last) => { const v = rows[r]?.[c + 2]; return typeof v === 'number' ? v : parseFloat(v) || 0; };
      const now = new Date();
      const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
      let lookbackIdx = 0;
      for (let i = dates.length - 1; i >= 0; i--) { const d = new Date(dates[i]); if (d <= ninetyDaysAgo) { lookbackIdx = i; break; } }
      const series = dates.map((d, i) => ({ date: fmtDate(d), nwUSD: get(4, i), nwBTC: get(3, i), btcPrice: get(1, i) })).filter(x => x.nwUSD > 0);
      const btcPrice = get(1), btcStack = get(2), home = get(10), mortgage = get(18), heloc = get(16), homeEq = home - mortgage - heloc;
      const btcVal = btcStack * btcPrice, jonCar = get(13), lenoraCar = get(23), cars = jonCar + lenoraCar;
      const jonCash = get(14), lenoraCash = get(24), cash = jonCash + lenoraCash;
      const jonIRA = get(11), lenoraIRA = get(22), ira = jonIRA + lenoraIRA;
      return {
        cur: { btcPrice, btcStack, nwBTC: get(3), nwUSD: get(4), assets: get(5), liab: get(6), jonNW: get(7), lenoraNW: get(19), home, ira, btcVal, cash, cars, homeEq, mortgage, heloc, studentLoans: get(17) + get(25) },
        prev90: { nwUSD: get(4, lookbackIdx), assets: get(5, lookbackIdx), liab: get(6, lookbackIdx), btcStack: get(2, lookbackIdx) },
        series, lastDate: fmtDate(dates[last])
      };
    };

    const parseCF = raw => {
      if (!raw?.sheets) return null;
      const exp = raw.sheets['Expenses and Income'];
      const bills = raw.sheets['Bills'];
      const taxes = raw.sheets['Taxes and IRA'];
      const yearCol = 3;
      const year = exp[0]?.[yearCol] || 2025;
      const get = (r) => { const v = exp[r]?.[yearCol]; return typeof v === 'number' ? v : parseFloat(v) || 0; };
      let grossIncome = 0, jonGross = 0, lenoraGross = 0, fedTax = 0, stateTax = 0, monthlyTax = 0, taxRate = 0;
      if (taxes) {
        for (let i = 1; i < taxes.length; i++) {
          if (taxes[i][0] === 2024 || taxes[i][0] === '2024') {
            grossIncome = taxes[i][1] || 0; jonGross = taxes[i][2] || 0; lenoraGross = grossIncome - jonGross;
            fedTax = taxes[i][14] || 0; stateTax = taxes[i][15] || 0;
            const totalTax = fedTax + stateTax; monthlyTax = totalTax / 12; taxRate = grossIncome > 0 ? (totalTax / grossIncome) * 100 : 0;
            break;
          }
        }
      }
      const expenseLabels = [{ row: 5, label: 'Mortgage' }, { row: 6, label: 'Student Loans' }, { row: 9, label: 'PG&E' }, { row: 10, label: 'Water' }, { row: 11, label: 'Auto Insurance' }, { row: 12, label: 'Verizon' }, { row: 13, label: 'Bramble Trail' }, { row: 14, label: 'Internet' }, { row: 15, label: 'Life Insurance' }, { row: 16, label: 'Trash' }, { row: 17, label: 'Audible' }, { row: 18, label: 'Netflix' }, { row: 19, label: 'Amazon Prime' }, { row: 20, label: 'Spotify' }, { row: 21, label: 'Tesla Premium' }, { row: 22, label: 'Rent' }];
      const expenseItems = expenseLabels.map(({ row, label }) => ({ label, value: get(row) })).filter(item => item.value > 0);
      expenseItems.sort((a, b) => b.value - a.value);
      const topExpenses = expenseItems.slice(0, 5);
      const othersTotal = expenseItems.slice(5).reduce((sum, item) => sum + item.value, 0);
      const billsData = [];
      let avgBills = { water: 0, energy: 0, trash: 0, internet: 0, total: 0 };
      if (bills) {
        for (let i = 1; i < bills.length; i++) {
          const row = bills[i];
          if (!row[0]) continue;
          const water = row[1] || 0, energy = row[2] || 0, trash = row[3] || 0, internet = row[4] || 0;
          if (water > 0 && energy > 0 && trash > 0) {
            billsData.push({ month: row[0], water, energy, trash, internet });
          }
        }
        if (billsData.length > 0) {
          avgBills.water = billsData.reduce((s, b) => s + b.water, 0) / billsData.length;
          avgBills.energy = billsData.reduce((s, b) => s + b.energy, 0) / billsData.length;
          avgBills.trash = billsData.reduce((s, b) => s + b.trash, 0) / billsData.length;
          avgBills.internet = billsData.reduce((s, b) => s + b.internet, 0) / billsData.length;
          avgBills.total = avgBills.water + avgBills.energy + avgBills.trash + avgBills.internet;
        }
      }
      const totalIRA = get(4), btcPurchases = 3000, homeEquityAdded = get(2) || 1500;
      return { year, grossIncome: grossIncome / 12, jonGross: jonGross / 12, lenoraGross: lenoraGross / 12, takeHome: get(1), expenses: get(23), netInflow: get(24), totalIRA, btcPurchases, homeEquityAdded, fedTax: fedTax / 12, stateTax: stateTax / 12, monthlyTax, taxRate, topExpenses, othersExpense: othersTotal, avgBills, bills: billsData.reverse() };
    };

    const set90dTrend = (el, cur, prev) => {
      if (!prev || prev === 0) return;
      const pct = ((cur - prev) / Math.abs(prev)) * 100;
      el.textContent = `${pct >= 0 ? '↑' : '↓'} ${Math.abs(pct).toFixed(1)}% (90d)`;
      el.className = `text-xs ${pct >= 0 ? 'positive' : 'negative'}`;
    };

    const renderNW = nw => {
      document.getElementById('lastDate').textContent = `Data: ${nw.lastDate}`;
      document.getElementById('netWorth').textContent = fmt(nw.cur.nwUSD, true);
      document.getElementById('netWorthBTC').textContent = fmtBTC(nw.cur.nwBTC);
      document.getElementById('totalAssets').textContent = fmt(nw.cur.assets, true);
      document.getElementById('totalLiab').textContent = fmt(nw.cur.liab, true);
      document.getElementById('btcStack').textContent = fmtBTC(nw.cur.btcStack);
      document.getElementById('btcPrice').textContent = `@ ${fmt(nw.cur.btcPrice)}`;
      set90dTrend(document.getElementById('netWorthTrend'), nw.cur.nwUSD, nw.prev90.nwUSD);
      set90dTrend(document.getElementById('assetsTrend'), nw.cur.assets, nw.prev90.assets);
      set90dTrend(document.getElementById('liabTrend'), nw.cur.liab, nw.prev90.liab);
      set90dTrend(document.getElementById('btcTrend'), nw.cur.btcStack, nw.prev90.btcStack);
      document.getElementById('jonNW').textContent = fmt(nw.cur.jonNW, true);
      document.getElementById('lenoraNW').textContent = fmt(nw.cur.lenoraNW, true);
      document.getElementById('homeVal').textContent = fmt(nw.cur.home, true);
      document.getElementById('iraVal').textContent = fmt(nw.cur.ira, true);
      document.getElementById('btcVal').textContent = fmt(nw.cur.btcVal, true);
      document.getElementById('cashVal').textContent = fmt(nw.cur.cash, true);
      document.getElementById('carsVal').textContent = fmt(nw.cur.cars, true);
      document.getElementById('homeEqVal').textContent = fmt(nw.cur.homeEq, true);
      document.getElementById('mortgageVal').textContent = fmt(nw.cur.mortgage, true);
      const helocCard = document.getElementById('helocCard');
      if (nw.cur.heloc === 0) {
        helocCard.style.display = 'none';
      } else {
        helocCard.style.display = 'block';
        document.getElementById('helocVal').textContent = fmt(nw.cur.heloc, true);
      }
      const studentCard = document.getElementById('studentCard');
      const studentVal = document.getElementById('studentVal');
      if (nw.cur.studentLoans === 0) {
        studentVal.textContent = 'Paid';
        studentVal.className = 'text-lg positive';
      } else {
        studentVal.textContent = fmt(nw.cur.studentLoans, true);
      }
      const ctx = document.getElementById('nwChart').getContext('2d');
      if (nwChart) nwChart.destroy();
      nwChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: nw.series.map(d => d.date),
          datasets: [
            { label: 'USD', data: nw.series.map(d => d.nwUSD), borderColor: COLORS.primary, backgroundColor: 'rgba(26, 22, 18, 0.05)', fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2, yAxisID: 'y' },
            { label: 'BTC', data: nw.series.map(d => d.nwBTC), borderColor: COLORS.light, backgroundColor: 'transparent', fill: false, tension: 0.3, pointRadius: 0, borderWidth: 1.5, borderDash: [4, 4], yAxisID: 'y1' }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false }, ticks: { color: COLORS.secondary, font: { size: 10 }, maxRotation: 45 } },
            y: { position: 'left', grid: { color: COLORS.grid }, ticks: { color: COLORS.primary, font: { size: 10 }, callback: v => `$${(v/1e6).toFixed(1)}M` } },
            y1: { position: 'right', grid: { display: false }, ticks: { color: COLORS.light, font: { size: 10 }, callback: v => `${v.toFixed(0)} BTC` } }
          }
        }
      });
    };

    const renderCF = cf => {
      document.getElementById('cfYear').textContent = `(${cf.year} avg)`;
      document.getElementById('grossIncome').textContent = fmt(cf.grossIncome);
      document.getElementById('takeHome').textContent = fmt(cf.takeHome);
      document.getElementById('monthlyTax').textContent = fmt(cf.monthlyTax);
      document.getElementById('taxRate').textContent = `${cf.taxRate.toFixed(1)}% effective`;
      document.getElementById('expenses').textContent = fmt(cf.expenses);
      document.getElementById('netInflow').textContent = fmt(cf.netInflow);
      const totalSavings = cf.btcPurchases + cf.totalIRA + cf.homeEquityAdded;
      document.getElementById('totalSavings').textContent = fmt(totalSavings);
      const freeCash = cf.netInflow - cf.btcPurchases - cf.avgBills.total;
      document.getElementById('freeCash').textContent = fmt(freeCash);
      document.getElementById('ttJonSalary').textContent = fmt(cf.jonGross);
      document.getElementById('ttLenoraSalary').textContent = fmt(cf.lenoraGross);
      document.getElementById('ttGrossForTakeHome').textContent = fmt(cf.grossIncome);
      document.getElementById('ttFedTaxTakeHome').textContent = '−' + fmt(cf.fedTax);
      document.getElementById('ttStateTaxTakeHome').textContent = '−' + fmt(cf.stateTax);
      document.getElementById('ttIRATakeHome').textContent = '−' + fmt(cf.totalIRA);
      document.getElementById('ttNetTakeHome').textContent = fmt(cf.takeHome);
      document.getElementById('ttFedTax').textContent = fmt(cf.fedTax);
      document.getElementById('ttStateTax').textContent = fmt(cf.stateTax);
      document.getElementById('ttTotalTax').textContent = fmt(cf.monthlyTax);
      document.getElementById('ttTaxRate').textContent = `${cf.taxRate.toFixed(1)}%`;
      const expTooltip = document.getElementById('expensesTooltip');
      let expHTML = '';
      cf.topExpenses.forEach(item => {
        expHTML += `<div class="tooltip-row"><span class="text-xs ink-faded">${item.label}</span><span class="text-sm ink">${fmt(item.value)}</span></div>`;
      });
      if (cf.othersExpense > 0) {
        expHTML += `<div class="tooltip-row"><span class="text-xs ink-faded">Others</span><span class="text-sm ink">${fmt(cf.othersExpense)}</span></div>`;
      }
      expHTML += `<div class="tooltip-row" style="border-top: 1px solid #d9d0c1; margin-top: 4px; padding-top: 8px;"><span class="text-xs font-medium ink">Total</span><span class="text-sm font-medium ink">${fmt(cf.expenses)}</span></div>`;
      expTooltip.innerHTML = expHTML;
      document.getElementById('ttTakeHomeForInflow').textContent = '+' + fmt(cf.takeHome);
      document.getElementById('ttExpensesForInflow').textContent = '−' + fmt(cf.expenses);
      document.getElementById('ttNetInflow').textContent = fmt(cf.netInflow);
      document.getElementById('ttBTCSavings').textContent = fmt(cf.btcPurchases);
      document.getElementById('ttIRASavings').textContent = fmt(cf.totalIRA);
      document.getElementById('ttHomeEquity').textContent = fmt(cf.homeEquityAdded);
      document.getElementById('ttTotalSavings').textContent = fmt(totalSavings);
      document.getElementById('ttInflowForFree').textContent = '+' + fmt(cf.netInflow);
      document.getElementById('ttBTCForFree').textContent = '−' + fmt(cf.btcPurchases);
      document.getElementById('ttBillsForFree').textContent = '−' + fmt(cf.avgBills.total);
      document.getElementById('ttFreeCash').textContent = fmt(freeCash);
      const ctx = document.getElementById('billsChart').getContext('2d');
      if (billsChart) billsChart.destroy();
      billsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: cf.bills.map(b => b.month),
          datasets: [
            { label: 'Energy', data: cf.bills.map(b => b.energy), borderColor: COLORS.primary, backgroundColor: 'transparent', tension: 0.3, pointRadius: 2, borderWidth: 1.5 },
            { label: 'Water', data: cf.bills.map(b => b.water), borderColor: COLORS.secondary, backgroundColor: 'transparent', tension: 0.3, pointRadius: 2, borderWidth: 1.5 },
            { label: 'Internet', data: cf.bills.map(b => b.internet), borderColor: COLORS.light, backgroundColor: 'transparent', tension: 0.3, pointRadius: 2, borderWidth: 1.5 },
            { label: 'Trash', data: cf.bills.map(b => b.trash), borderColor: COLORS.light, backgroundColor: 'transparent', tension: 0.3, pointRadius: 2, borderWidth: 1, borderDash: [3, 3] }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: true, position: 'top', labels: { color: COLORS.secondary, boxWidth: 12, padding: 10, font: { size: 10 } } } }, scales: { x: { grid: { display: false }, ticks: { color: COLORS.secondary, font: { size: 9 }, maxRotation: 45 } }, y: { grid: { color: COLORS.grid }, ticks: { color: COLORS.secondary, font: { size: 10 }, callback: v => `$${v}` } } } }
      });
    };

    const RETIRE_CONFIG = {
      btcRate: 0.10, iraRate: 0.08, homeRate: 0.05, variableInflationRate: 0.06, jonSalaryGrowthRate: 0.03, lenoraSalaryGrowthRate: 0.05, portfolioMultiple: 35, startYear: 2026,
      totalBaseExpenses: 118301, fixedMortgagePayment: 38268, baseVariableExpenses: 80033,
      startHomeValue: 1191100, startIRA: 1047848, startBTC: 705041, startCars: 27555, startCash: 10000,
      startMortgage: 635702, startHELOC: 28245, startStudentLoans: 250000, studentLoanForgivenessYear: 9,
      baseBTCMonthly: 3000, baseJonIRAMonthly: 1088.17, baseLenIRAMonthly: 1088.17,
      pensionMonthly: 3000, pensionAnnual: 36000, pensionStartAge: 65, currentAge: 37, pensionStartYear: 2054,
      getMortgagePrincipal: function(year) {
        const yearPrincipals = [1501, 1551, 1603, 1656, 1712, 1769, 1828, 1889, 1953, 2018, 2085, 2154, 2225, 2299, 2375, 2454, 2535, 2619, 2706, 2795];
        return yearPrincipals[Math.min(year - 1, yearPrincipals.length - 1)];
      }
    };

    const calculateRetirement = (liveNW) => {
      const cfg = RETIRE_CONFIG;
      const projection = [];
      let homeValue = cfg.startHomeValue, mortgageBalance = cfg.startMortgage, helocBalance = cfg.startHELOC;
      let studentLoans = cfg.startStudentLoans, ira = cfg.startIRA, btc = cfg.startBTC;
      let cars = cfg.startCars, cash = cfg.startCash;
      const calcNW = () => homeValue - mortgageBalance - helocBalance - studentLoans + ira + btc + cars + cash;
      if (liveNW && liveNW > 0) {
        const componentNW = calcNW();
        cash += liveNW - componentNW;
      }
      let targetYear = null;
      const startingNW = calcNW();
      for (let year = 1; year <= 30; year++) {
        const startNW = calcNW();
        const jonSalaryMultiplier = Math.pow(1 + cfg.jonSalaryGrowthRate, year - 1);
        const lenSalaryMultiplier = Math.pow(1 + cfg.lenoraSalaryGrowthRate, year - 1);
        const btcMonthly = cfg.baseBTCMonthly * jonSalaryMultiplier;
        const jonIRAMonthly = cfg.baseJonIRAMonthly * jonSalaryMultiplier;
        const lenIRAMonthly = cfg.baseLenIRAMonthly * lenSalaryMultiplier;
        const iraMonthly = jonIRAMonthly + lenIRAMonthly;
        const mortgagePrincipalMonthly = cfg.getMortgagePrincipal(year);
        const annualBTCSavings = btcMonthly * 12;
        const annualIRASavings = iraMonthly * 12;
        const annualMortgagePrincipal = mortgagePrincipalMonthly * 12;
        const ageAtYearEnd = cfg.currentAge + year;
        const pensionActive = ageAtYearEnd >= cfg.pensionStartAge;
        const pensionIncome = pensionActive ? cfg.pensionAnnual : 0;
        const totalAnnualSavings = annualBTCSavings + annualIRASavings + annualMortgagePrincipal;
        const homeAppreciation = homeValue * cfg.homeRate;
        const iraAppreciation = ira * cfg.iraRate;
        const btcAppreciation = btc * cfg.btcRate;
        const carDepreciation = cars * 0.10;
        const iraGrowthOnNew = annualIRASavings * cfg.iraRate * 0.5;
        const btcGrowthOnNew = annualBTCSavings * cfg.btcRate * 0.5;
        const totalAppreciation = homeAppreciation + iraAppreciation + btcAppreciation + iraGrowthOnNew + btcGrowthOnNew - carDepreciation;
        homeValue = homeValue * (1 + cfg.homeRate);
        mortgageBalance = mortgageBalance - annualMortgagePrincipal;
        cars = cars * 0.90;
        if (year === 1 && helocBalance > 0) helocBalance = 0;
        if (year === cfg.studentLoanForgivenessYear) studentLoans = 0;
        ira = ira + iraAppreciation + annualIRASavings + iraGrowthOnNew;
        btc = btc + btcAppreciation + annualBTCSavings + btcGrowthOnNew;
        const endNW = calcNW();
        const variableExpenses = cfg.baseVariableExpenses * Math.pow(1 + cfg.variableInflationRate, year);
        const totalExpenses = cfg.fixedMortgagePayment + variableExpenses;
        const requiredPortfolio = totalExpenses * cfg.portfolioMultiple;
        const pensionAdjustedExpenses = pensionActive ? Math.max(0, totalExpenses - cfg.pensionAnnual) : totalExpenses;
        const requiredWithPension = pensionAdjustedExpenses * cfg.portfolioMultiple;
        const gap = endNW - requiredPortfolio;
        const gapWithPension = endNW - requiredWithPension;
        if (gap >= 0 && !targetYear) targetYear = cfg.startYear + year;
        projection.push({
          year, calendarYear: cfg.startYear + year, startNW, totalAnnualSavings, totalAppreciation, endNW,
          fixedExpenses: cfg.fixedMortgagePayment, variableExpenses, totalExpenses, requiredPortfolio, requiredWithPension,
          pensionActive, pensionIncome, ageAtYearEnd, gap, gapWithPension,
          homeValue, mortgageBalance, homeEquity: homeValue - mortgageBalance, ira, btc, cars, cash, studentLoans,
          btcMonthly, iraMonthly, mortgagePrincipalMonthly
        });
      }
      return { projection, targetYear, startingNW };
    };

    const toggleRetireSection = (section) => {
      const content = document.getElementById(section + 'Content');
      const chevron = document.getElementById(section + 'Chevron');
      content.classList.toggle('hidden');
      chevron.classList.toggle('rotate-180');
    };

    const renderRetirement = (liveNW) => {
      const { projection, targetYear, startingNW } = calculateRetirement(liveNW);
      const cfg = RETIRE_CONFIG;
      const targetIdx = projection.findIndex(p => p.gap >= 0);
      const target = targetIdx >= 0 ? projection[targetIdx] : projection[projection.length - 1];
      const displayNW = liveNW && liveNW > 0 ? liveNW : startingNW;
      document.getElementById('retireCurrentNW').textContent = fmt(displayNW, true);
      document.getElementById('retireTarget').textContent = fmt(target.requiredPortfolio, true);
      document.getElementById('retireYears').textContent = targetIdx >= 0 ? (targetIdx + 1) : '>30';
      document.getElementById('retireTargetYear').textContent = targetYear || '2056+';
      document.getElementById('retireHeroYear').textContent = targetYear || '2056+';
      const ctx = document.getElementById('retireChart').getContext('2d');
      if (retireChart) retireChart.destroy();
      const crossoverIdx = projection.findIndex(p => p.gap >= 0);
      retireChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: projection.map(p => p.calendarYear),
          datasets: [
            { label: 'Projected Net Worth', data: projection.map(p => p.endNW), borderColor: COLORS.primary, backgroundColor: 'rgba(26, 22, 18, 0.08)', fill: true, tension: 0.3, borderWidth: 2, pointRadius: projection.map((p, i) => i === crossoverIdx ? 6 : 2), pointBackgroundColor: projection.map((p, i) => i === crossoverIdx ? '#5a7a5a' : COLORS.primary) },
            { label: 'Required (35×)', data: projection.map(p => p.requiredPortfolio), borderColor: COLORS.secondary, backgroundColor: 'transparent', borderDash: [5, 5], tension: 0.3, pointRadius: 0, borderWidth: 1.5 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + fmt(ctx.raw, true), afterBody: ctx => { const idx = ctx[0].dataIndex; const p = projection[idx]; const notes = []; if (p.calendarYear === 2035) notes.push('★ Student loans forgiven'); if (p.gap >= 0 && idx === crossoverIdx) notes.push('✓ Target reached'); return notes; } } } }, scales: { x: { grid: { display: false }, ticks: { color: COLORS.secondary, font: { size: 10 } } }, y: { grid: { color: COLORS.grid }, ticks: { color: COLORS.secondary, font: { size: 10 }, callback: v => `$${(v/1e6).toFixed(1)}M` } } } }
      });
      const yearTable = document.getElementById('yearByYearTable');
      yearTable.innerHTML = projection.map(p => `<tr class="${p.gap >= 0 ? 'highlight' : ''} ${p.calendarYear === 2035 ? 'milestone' : ''}"><td>${p.calendarYear}${p.calendarYear === 2035 ? ' ★' : ''}${p.gap >= 0 && projection[p.year - 2]?.gap < 0 ? ' ✓' : ''}</td><td>${fmt(p.startNW, true)}</td><td>${fmt(p.totalAnnualSavings, true)}</td><td>${fmt(p.totalAppreciation, true)}</td><td style="font-weight: 500;">${fmt(p.endNW, true)}</td><td>${fmt(p.totalExpenses, true)}</td><td>${fmt(p.requiredPortfolio, true)}</td><td class="${p.gap >= 0 ? 'positive' : 'negative'}">${p.gap >= 0 ? '+' : ''}${fmt(p.gap, true)}</td></tr>`).join('');
      const savingsTable = document.getElementById('savingsTable');
      savingsTable.innerHTML = projection.map(p => `<tr><td>${p.calendarYear}</td><td>$${Math.round(p.btcMonthly).toLocaleString()}</td><td>$${Math.round(p.iraMonthly).toLocaleString()}</td><td>${fmt(p.btcMonthly + p.iraMonthly)}</td><td style="font-weight: 500;">${fmt(p.totalAnnualSavings, true)}</td></tr>`).join('');
      const assetTable = document.getElementById('assetGrowthTable');
      const startRow = { year: cfg.startYear, homeEquity: cfg.startHomeValue - cfg.startMortgage - cfg.startHELOC, ira: cfg.startIRA, btc: cfg.startBTC, cars: cfg.startCars, cash: cfg.startCash, studentLoans: cfg.startStudentLoans, endNW: startingNW };
      assetTable.innerHTML = [startRow, ...projection].map(p => `<tr class="${p.studentLoans === 0 && p.year !== cfg.startYear ? 'milestone' : ''}"><td>${p.year || p.calendarYear}</td><td>${fmt(p.homeEquity, true)}</td><td>${fmt(p.ira, true)}</td><td>${fmt(p.btc, true)}</td><td>${fmt((p.cars || 0) + (p.cash || 0), true)}</td><td class="${p.studentLoans > 0 ? 'negative' : 'positive'}">${p.studentLoans > 0 ? '−' + fmt(p.studentLoans, true) : '$0'}</td><td style="font-weight: 500;">${fmt(p.endNW, true)}</td></tr>`).join('');
    };

    const showLoading = show => { document.getElementById('loading').classList.toggle('hidden', !show); document.getElementById('refreshIcon').classList.toggle('animate-spin', show); };
    const showError = msg => { document.getElementById('loading').classList.add('hidden'); document.getElementById('content').classList.add('hidden'); document.getElementById('error').classList.remove('hidden'); document.getElementById('errorMsg').textContent = msg; };
    const showContent = () => { document.getElementById('loading').classList.add('hidden'); document.getElementById('error').classList.add('hidden'); document.getElementById('content').classList.remove('hidden'); };

    async function loadData() {
      showLoading(true);
      let nwData = null, cfData = null, nwErr = null, cfErr = null;
      try {
        const r = await fetch(API.netWorth);
        nwData = await r.json();
        document.getElementById('nwStatus').className = 'w-2 h-2 rounded-full status-good';
      } catch (e) {
        nwErr = e.message;
        document.getElementById('nwStatus').className = 'w-2 h-2 rounded-full status-bad';
      }
      try {
        const r = await fetch(API.cashFlow);
        cfData = await r.json();
        document.getElementById('cfStatus').className = 'w-2 h-2 rounded-full status-good';
      } catch (e) {
        cfErr = e.message;
        document.getElementById('cfStatus').className = 'w-2 h-2 rounded-full status-bad';
      }
      showLoading(false);
      document.getElementById('fetchTime').textContent = new Date().toLocaleTimeString();
      if (!nwData && !cfData) {
        showError(nwErr || cfErr || 'Unknown error');
        return;
      }
      showContent();
      if (nwData) {
        const nw = parseNW(nwData);
        if (nw) {
          renderNW(nw);
          renderRetirement(nw.cur.nwUSD);
        }
      }
      if (cfData) {
        const cf = parseCF(cfData);
        if (cf) renderCF(cf);
      }
    }

    loadData();
    loadMarketData();
  </script>

</body>
</html>