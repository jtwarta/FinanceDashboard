<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personal Finance Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #0f172a; }
    .glass { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(8px); }

/* Tooltip system */
.tooltip-wrapper {
  position: relative;
}
.tooltip-content {
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: rgba(15, 23, 42, 0.95);
  border: 1px solid rgba(100, 116, 139, 0.4);
  border-radius: 12px;
  padding: 12px 16px;
  min-width: 200px;
  max-width: 280px;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s, visibility 0.2s;
  z-index: 50;
  backdrop-filter: blur(8px);
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
}
.tooltip-content::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 8px solid transparent;
  border-top-color: rgba(100, 116, 139, 0.4);
}
.tooltip-wrapper:hover .tooltip-content {
  opacity: 1;
  visibility: visible;
}
.tooltip-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  border-bottom: 1px solid rgba(100, 116, 139, 0.2);
}
.tooltip-row:last-child {
  border-bottom: none;
}
.tooltip-label {
  color: #94a3b8;
  font-size: 12px;
}
.tooltip-value {
  font-weight: 600;
  font-size: 13px;
}
.tooltip-title {
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #64748b;
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 1px solid rgba(100, 116, 139, 0.3);
}

  </style>
</head>
<body class="min-h-screen text-white">
  <div class="fixed inset-0 bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950">
    <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-emerald-900/20 via-transparent to-transparent"></div>
  </div>

  <div id="app" class="relative max-w-6xl mx-auto px-4 py-6">
    <header class="flex items-center justify-between mb-6 flex-wrap gap-4">
      <div>
        <h1 class="text-2xl font-bold bg-gradient-to-r from-white to-slate-400 bg-clip-text text-transparent">Personal Finance Hub</h1>
        <p id="lastDate" class="text-slate-500 text-sm"></p>
      </div>
      <div class="flex items-center gap-3">
        <span id="fetchTime" class="text-xs text-slate-500"></span>
        <button onclick="loadData()" id="refreshBtn" class="flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-800 border border-slate-700 hover:bg-slate-700">
          <svg id="refreshIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
          <span class="text-sm">Refresh</span>
        </button>
      </div>
    </header>

<!-- Market Trackers -->
<div class="rounded-2xl border border-slate-700/50 glass p-4 mb-6">
  <div class="grid grid-cols-2 gap-4 mb-3">
    <div>
      <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Bitcoin</p>
      <p id="btcLivePrice" class="text-xl font-bold text-orange-400">Loading...</p>
      <p id="btcChange" class="text-xs text-slate-500">--</p>
    </div>
    <div class="text-right">
      <p class="text-xs font-medium uppercase tracking-wider text-slate-400">S&P 500</p>
      <p id="spLivePrice" class="text-xl font-bold text-blue-400">Loading...</p>
      <p id="spChange" class="text-xs text-slate-500">--</p>
    </div>
  </div>
  <div style="height: 80px; position: relative;">
    <canvas id="marketSparkline"></canvas>
  </div>
  <p class="text-[10px] text-slate-500 text-center mt-1">90-day normalized performance: <span class="text-orange-400">BTC</span> vs <span class="text-blue-400">S&P 500</span></p>
</div>

<div id="loading" class="flex justify-center py-16">
  <div class="w-10 h-10 rounded-full border-2 border-emerald-500 border-t-transparent animate-spin"></div>
</div>

<div id="error" class="hidden rounded-2xl border border-rose-500/30 bg-rose-500/10 p-6 text-center">
  <svg class="w-8 h-8 text-rose-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
  <p class="text-rose-300 mb-2">Failed to fetch data</p>
  <p id="errorMsg" class="text-xs text-rose-400/70 mb-4"></p>
  <button onclick="loadData()" class="px-4 py-2 rounded-lg bg-rose-500/20 border border-rose-500/40 text-rose-300 hover:bg-rose-500/30 text-sm">Retry</button>
</div>

<div id="content" class="hidden space-y-8">
  <!-- Net Worth Section -->
  <section>
    <h2 class="text-lg font-semibold text-white flex items-center gap-2 mb-4">
      <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
      Net Worth Overview
    </h2>
    
    <!-- Top row: main stats with 90-day trends -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-5">
      <div class="rounded-2xl bg-gradient-to-br from-emerald-500/20 to-emerald-600/5 border border-emerald-500/30 p-5">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Net Worth</p>
        <p id="netWorth" class="text-2xl font-bold">-</p>
        <p id="netWorthBTC" class="text-xs text-slate-400"></p>
        <p id="netWorthTrend" class="mt-2 text-xs font-medium"></p>
      </div>
      <div class="rounded-2xl bg-gradient-to-br from-blue-500/20 to-blue-600/5 border border-blue-500/30 p-5">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Total Assets</p>
        <p id="totalAssets" class="text-2xl font-bold">-</p>
        <p id="assetsTrend" class="mt-2 text-xs font-medium"></p>
      </div>
      <div class="rounded-2xl bg-gradient-to-br from-rose-500/20 to-rose-600/5 border border-rose-500/30 p-5">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Total Liabilities</p>
        <p id="totalLiab" class="text-2xl font-bold">-</p>
        <p id="liabTrend" class="mt-2 text-xs font-medium"></p>
      </div>
      <div class="rounded-2xl bg-gradient-to-br from-orange-500/20 to-orange-600/5 border border-orange-500/30 p-5">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">BTC Stack</p>
        <p id="btcStack" class="text-2xl font-bold">-</p>
        <p id="btcPrice" class="text-xs text-slate-400"></p>
        <p id="btcTrend" class="mt-2 text-xs font-medium"></p>
      </div>
    </div>

    <!-- Jon & Lenora boxes - moved above chart -->
    <div class="grid grid-cols-2 gap-4 mb-5">
      <div class="rounded-2xl border border-blue-500/30 bg-blue-500/10 p-4">
        <p class="text-sm text-blue-300">Jon</p>
        <p id="jonNW" class="text-xl font-bold">-</p>
      </div>
      <div class="rounded-2xl border border-violet-500/30 bg-violet-500/10 p-4">
        <p class="text-sm text-violet-300">Lenora</p>
        <p id="lenoraNW" class="text-xl font-bold">-</p>
      </div>
    </div>

    <!-- Net Worth History Chart: Blue=USD, Orange=BTC -->
    <div class="rounded-2xl border border-slate-700/50 glass p-4 mb-5">
      <div class="flex justify-between items-start mb-1">
        <h3 class="text-sm font-medium text-white">Net Worth History</h3>
        <span class="text-[10px] px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500/30">historical data</span>
      </div>
      <p class="text-xs text-slate-500 mb-3"><span class="text-blue-400">---</span> USD &nbsp; <span class="text-orange-400">---</span> BTC</p>
      <div style="height: 200px; position: relative;">
        <canvas id="nwChart"></canvas>
      </div>
    </div>

    <!-- Asset breakdown -->
    <div class="grid grid-cols-3 lg:grid-cols-6 gap-3 mb-5">
      <div class="rounded-2xl bg-gradient-to-br from-blue-500/20 to-blue-600/5 border border-blue-500/30 p-3">
        <p class="text-[10px] font-medium uppercase tracking-wider text-slate-400">Home</p>
        <p id="homeVal" class="text-lg font-bold">-</p>
      </div>
      <div class="rounded-2xl bg-gradient-to-br from-violet-500/20 to-violet-600/5 border border-violet-500/30 p-3">
        <p class="text-[10px] font-medium uppercase tracking-wider text-slate-400">IRA</p>
        <p id="iraVal" class="text-lg font-bold">-</p>
      </div>
      <div class="rounded-2xl bg-gradient-to-br from-orange-500/20 to-orange-600/5 border border-orange-500/30 p-3">
        <p class="text-[10px] font-medium uppercase tracking-wider text-slate-400">Bitcoin</p>
        <p id="btcVal" class="text-lg font-bold">-</p>
      </div>
      <div class="rounded-2xl bg-gradient-to-br from-emerald-500/20 to-emerald-600/5 border border-emerald-500/30 p-3">
        <p class="text-[10px] font-medium uppercase tracking-wider text-slate-400">Cash</p>
        <p id="cashVal" class="text-lg font-bold">-</p>
      </div>
      <div class="rounded-2xl bg-gradient-to-br from-cyan-500/20 to-cyan-600/5 border border-cyan-500/30 p-3">
        <p class="text-[10px] font-medium uppercase tracking-wider text-slate-400">Cars</p>
        <p id="carsVal" class="text-lg font-bold">-</p>
      </div>
      <div class="rounded-2xl bg-gradient-to-br from-amber-500/20 to-amber-600/5 border border-amber-500/30 p-3">
        <p class="text-[10px] font-medium uppercase tracking-wider text-slate-400">Home Equity</p>
        <p id="homeEqVal" class="text-lg font-bold">-</p>
      </div>
    </div>

    <!-- Liabilities breakdown -->
    <div class="grid grid-cols-3 gap-3">
      <div class="rounded-2xl bg-gradient-to-br from-rose-500/20 to-rose-600/5 border border-rose-500/30 p-3">
        <p class="text-[10px] font-medium uppercase tracking-wider text-slate-400">Mortgage</p>
        <p id="mortgageVal" class="text-lg font-bold">-</p>
      </div>
      <div id="helocCard" class="rounded-2xl bg-gradient-to-br from-rose-500/20 to-rose-600/5 border border-rose-500/30 p-3">
        <p class="text-[10px] font-medium uppercase tracking-wider text-slate-400">HELOC</p>
        <p id="helocVal" class="text-lg font-bold">-</p>
      </div>
      <div id="studentCard" class="rounded-2xl p-3">
        <p class="text-[10px] font-medium uppercase tracking-wider text-slate-400">Student Loans</p>
        <p id="studentVal" class="text-lg font-bold">-</p>
      </div>
    </div>
  </section>

  <!-- Retirement Progress Section -->
  <section>
    <h2 class="text-lg font-semibold text-white flex items-center gap-2 mb-4">
      <svg class="w-5 h-5 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
      Financial Independence
      <span class="text-[10px] px-2 py-0.5 rounded-full bg-teal-500/20 text-teal-400 border border-teal-500/30 ml-2">projected</span>
    </h2>

    <!-- Hero Target Year -->
    <div class="rounded-2xl bg-gradient-to-br from-emerald-500/10 via-teal-500/10 to-cyan-500/10 border border-emerald-500/30 p-6 mb-5 text-center">
      <p class="text-sm font-medium uppercase tracking-wider text-slate-400 mb-2">Financial Independence Target</p>
      <p id="retireHeroYear" class="text-6xl font-black bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 bg-clip-text text-transparent">--</p>
      <p class="text-slate-400 mt-2">
        <span id="retireYears" class="text-white font-bold">--</span> years from now
      </p>
    </div>

    <!-- Stats Row -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-5">
      <div class="rounded-2xl bg-gradient-to-br from-slate-700/30 to-slate-800/30 border border-slate-700/50 p-4 text-center">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-500">Current NW</p>
        <p id="retireCurrentNW" class="text-xl font-bold text-white">-</p>
        <p class="text-xs text-slate-500">live from sheet</p>
      </div>
      <div class="rounded-2xl bg-gradient-to-br from-slate-700/30 to-slate-800/30 border border-slate-700/50 p-4 text-center">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-500">Target NW</p>
        <p id="retireTarget" class="text-xl font-bold text-white">-</p>
        <p class="text-xs text-slate-500">35× expenses (tax-adj)</p>
      </div>
      <div class="rounded-2xl bg-gradient-to-br from-slate-700/30 to-slate-800/30 border border-slate-700/50 p-4 text-center">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-500">Target Year</p>
        <p id="retireTargetYear" class="text-xl font-bold text-emerald-400">-</p>
        <p class="text-xs text-slate-500">NW >= Required</p>
      </div>
      <div class="tooltip-wrapper rounded-2xl bg-gradient-to-br from-indigo-500/20 to-indigo-600/5 border border-indigo-500/30 p-4 text-center cursor-help">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Pension (Low Est.)</p>
        <p id="pensionMonthly" class="text-xl font-bold text-indigo-400">$3,000/mo</p>
        <p class="text-xs text-slate-500">starts age 65</p>
        <div class="tooltip-content" style="min-width: 240px;">
          <div class="tooltip-title">Kaiser Pension (Plan A)</div>
          <div class="tooltip-row">
            <span class="tooltip-label">Monthly Benefit</span>
            <span class="tooltip-value text-indigo-400">$3,000</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Annual Income</span>
            <span class="tooltip-value text-indigo-400">$36,000</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Benefits Start</span>
            <span class="tooltip-value text-slate-300">Age 65 (2054)</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Portfolio Offset</span>
            <span class="tooltip-value text-emerald-400">-$1.26M</span>
          </div>
          <p class="text-[10px] text-slate-500 mt-2 italic">Lower-end estimate based on 25yr vested, retire at 50 scenario. Actual may be higher.</p>
        </div>
      </div>
    </div>

    <!-- Projection Chart -->
    <div class="rounded-2xl border border-slate-700/50 glass p-4 mb-5">
      <div class="flex justify-between items-start mb-1">
        <h3 class="text-sm font-medium text-white">Net Worth Projection</h3>
        <span class="text-[10px] px-2 py-0.5 rounded-full bg-teal-500/20 text-teal-400 border border-teal-500/30">projected</span>
      </div>
      <p class="text-xs text-slate-500 mb-3">
        <span class="inline-block w-3 h-3 rounded-full bg-teal-400/50 border border-teal-400 mr-1"></span> Projected NW &nbsp; 
        <span class="text-rose-400">---</span> Required (35x) &nbsp;
        <span class="text-indigo-400">---</span> Req. w/Pension &nbsp;
        <span class="text-amber-400">*</span> 2035 loans forgiven
      </p>
      <div style="height: 220px; position: relative;">
        <canvas id="retireChart"></canvas>
      </div>
    </div>

    <!-- Collapsible Details -->
    <div class="space-y-3">
      <!-- Assumptions Toggle -->
      <div class="rounded-2xl border border-slate-700/50 glass overflow-hidden">
        <button onclick="toggleRetireSection('assumptions')" class="w-full flex items-center justify-between p-4 hover:bg-slate-700/20 transition-colors">
          <span class="text-sm font-medium text-slate-300 flex items-center gap-2">
            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            Model Assumptions
          </span>
          <svg id="assumptionsChevron" class="w-5 h-5 text-slate-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </button>
        <div id="assumptionsContent" class="hidden border-t border-slate-700/50 p-4 bg-slate-800/30">
          <div class="grid grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
            <div>
              <p class="text-slate-500 text-xs uppercase tracking-wider mb-1">Asset Growth</p>
              <p class="text-slate-300">BTC: <span class="text-orange-400">10%</span>/yr</p>
              <p class="text-slate-300">IRAs: <span class="text-violet-400">8%</span>/yr</p>
              <p class="text-slate-300">Home: <span class="text-blue-400">5%</span>/yr</p>
              <p class="text-slate-300">Cars: <span class="text-slate-400">-10%</span>/yr (deprec)</p>
            </div>
            <div>
              <p class="text-slate-500 text-xs uppercase tracking-wider mb-1">Inflation Model</p>
              <p class="text-slate-300">Variable expenses: <span class="text-rose-400">6%</span>/yr</p>
              <p class="text-slate-300">Mortgage: <span class="text-emerald-400">Fixed</span> (3.25%)</p>
              <p class="text-slate-300">Salary Growth: Jon <span class="text-cyan-400">3%</span>, Lenora <span class="text-violet-400">5%</span>/yr</p>
            </div>
            <div>
              <p class="text-slate-500 text-xs uppercase tracking-wider mb-1">Expense Breakdown</p>
              <p class="text-slate-300">Total: $118,301/yr</p>
              <p class="text-slate-300">Fixed (mortgage): $38,268/yr</p>
              <p class="text-slate-300">Variable: $80,033/yr</p>
            </div>
            <div>
              <p class="text-slate-500 text-xs uppercase tracking-wider mb-1">Portfolio Rule</p>
              <p class="text-slate-300">Base: <span class="text-teal-400">30x</span> expenses</p>
              <p class="text-slate-300">Tax adj: <span class="text-amber-400">35x</span> (blended ~15%)</p>
              <p class="text-slate-300 text-xs italic">Roth + traditional mix</p>
            </div>
            <div>
              <p class="text-slate-500 text-xs uppercase tracking-wider mb-1">Key Milestones</p>
              <p class="text-slate-300">HELOC: <span class="text-emerald-400">Paid Sept 2026</span></p>
              <p class="text-slate-300">Student Loans: <span class="text-amber-400">Forgiven 2035</span></p>
              <p class="text-slate-300 text-xs italic">Lenora PSLF Year 20</p>
            </div>
            <div>
              <p class="text-slate-500 text-xs uppercase tracking-wider mb-1">Kaiser Pension</p>
              <p class="text-slate-300">Low estimate: <span class="text-indigo-400">$3,000/mo</span></p>
              <p class="text-slate-300">Benefits start: <span class="text-indigo-400">Age 65</span></p>
              <p class="text-slate-300">Portfolio offset: <span class="text-emerald-400">-$1.26M</span></p>
              <p class="text-slate-300 text-xs italic">Reduces required NW at 65</p>
            </div>
            <div>
              <p class="text-slate-500 text-xs uppercase tracking-wider mb-1">Data Source</p>
              <p class="text-slate-300">Expenses: MIT Living Wage</p>
              <p class="text-slate-300">Location: Santa Rosa, CA</p>
              <p class="text-slate-300">Family: 2 adults, 2 children</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Year-by-Year Toggle -->
      <div class="rounded-2xl border border-slate-700/50 glass overflow-hidden">
        <button onclick="toggleRetireSection('yearByYear')" class="w-full flex items-center justify-between p-4 hover:bg-slate-700/20 transition-colors">
          <span class="text-sm font-medium text-slate-300 flex items-center gap-2">
            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            Year-by-Year Projection
          </span>
          <svg id="yearByYearChevron" class="w-5 h-5 text-slate-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </button>
        <div id="yearByYearContent" class="hidden border-t border-slate-700/50 p-4 bg-slate-800/30 overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-slate-500 text-xs uppercase tracking-wider">
                <th class="text-left py-2 pr-4">Year</th>
                <th class="text-right py-2 px-2">Start NW</th>
                <th class="text-right py-2 px-2">Savings</th>
                <th class="text-right py-2 px-2">Growth</th>
                <th class="text-right py-2 px-2">End NW</th>
                <th class="text-right py-2 px-2">Expenses</th>
                <th class="text-right py-2 px-2">Required</th>
                <th class="text-right py-2 pl-2">Gap</th>
              </tr>
            </thead>
            <tbody id="yearByYearTable" class="text-slate-300">
            </tbody>
          </table>
          <p class="text-xs text-slate-500 mt-3 italic">Note: Pension starts at age 65 (2054). Required column shows pension-adjusted values (indigo) when active.</p>
        </div>
      </div>

      <!-- Savings Toggle -->
      <div class="rounded-2xl border border-slate-700/50 glass overflow-hidden">
        <button onclick="toggleRetireSection('savings')" class="w-full flex items-center justify-between p-4 hover:bg-slate-700/20 transition-colors">
          <span class="text-sm font-medium text-slate-300 flex items-center gap-2">
            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            Monthly Savings by Year
          </span>
          <svg id="savingsChevron" class="w-5 h-5 text-slate-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </button>
        <div id="savingsContent" class="hidden border-t border-slate-700/50 p-4 bg-slate-800/30 overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-slate-500 text-xs uppercase tracking-wider">
                <th class="text-left py-2 pr-4">Year</th>
                <th class="text-right py-2 px-2">BTC Purchases</th>
                <th class="text-right py-2 px-2">IRA + Match</th>
                <th class="text-right py-2 px-2">Monthly Total</th>
                <th class="text-right py-2 pl-2">Annual Total</th>
              </tr>
            </thead>
            <tbody id="savingsTable" class="text-slate-300">
            </tbody>
          </table>
          <p class="text-xs text-slate-500 mt-3 italic">Note: Mortgage principal paydown (~$18K/yr) builds home equity but isn't counted as new savings.</p>
        </div>
      </div>

      <!-- Asset Growth Toggle -->
      <div class="rounded-2xl border border-slate-700/50 glass overflow-hidden">
        <button onclick="toggleRetireSection('assetGrowth')" class="w-full flex items-center justify-between p-4 hover:bg-slate-700/20 transition-colors">
          <span class="text-sm font-medium text-slate-300 flex items-center gap-2">
            <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
            Asset Growth Over Time
          </span>
          <svg id="assetGrowthChevron" class="w-5 h-5 text-slate-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </button>
        <div id="assetGrowthContent" class="hidden border-t border-slate-700/50 p-4 bg-slate-800/30 overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-slate-500 text-xs uppercase tracking-wider">
                <th class="text-left py-2 pr-4">Year</th>
                <th class="text-right py-2 px-2">Home Equity</th>
                <th class="text-right py-2 px-2">IRAs</th>
                <th class="text-right py-2 px-2">Bitcoin</th>
                <th class="text-right py-2 px-2">Cars + Cash</th>
                <th class="text-right py-2 px-2">Student Loans</th>
                <th class="text-right py-2 pl-2">Total NW</th>
              </tr>
            </thead>
            <tbody id="assetGrowthTable" class="text-slate-300">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Cash Flow Section -->
  <section>
    <h2 class="text-lg font-semibold text-white flex items-center gap-2 mb-4">
      <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z"></path></svg>
      Cash Flow <span id="cfYear" class="text-slate-500 text-sm font-normal ml-2"></span>
    </h2>

    <!-- Row 1: Income -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
      <!-- Gross Income -->
      <div class="tooltip-wrapper rounded-2xl bg-gradient-to-br from-cyan-500/20 to-cyan-600/5 border border-cyan-500/30 p-5 cursor-help">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Gross Income</p>
        <p id="grossIncome" class="text-2xl font-bold">-</p>
        <p class="text-xs text-slate-500">monthly avg</p>
        <div class="tooltip-content">
          <div class="tooltip-title">Gross Income Breakdown</div>
          <div id="grossIncomeTooltip">
            <div class="tooltip-row">
              <span class="tooltip-label">Jon's Salary</span>
              <span id="ttJonSalary" class="tooltip-value text-cyan-400">-</span>
            </div>
            <div class="tooltip-row">
              <span class="tooltip-label">Lenora's Salary</span>
              <span id="ttLenoraSalary" class="tooltip-value text-cyan-400">-</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Take-Home -->
      <div class="tooltip-wrapper rounded-2xl bg-gradient-to-br from-emerald-500/20 to-emerald-600/5 border border-emerald-500/30 p-5 cursor-help">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Take-Home</p>
        <p id="takeHome" class="text-2xl font-bold">-</p>
        <p class="text-xs text-slate-500">monthly avg</p>
        <div class="tooltip-content">
          <div class="tooltip-title">Take-Home Breakdown</div>
          <div id="takeHomeTooltip">
            <div class="tooltip-row">
              <span class="tooltip-label">Gross Income</span>
              <span id="ttGrossForTakeHome" class="tooltip-value text-cyan-400">-</span>
            </div>
            <div class="tooltip-row">
              <span class="tooltip-label">Federal Tax</span>
              <span id="ttFedTaxTakeHome" class="tooltip-value text-rose-400">-</span>
            </div>
            <div class="tooltip-row">
              <span class="tooltip-label">State Tax</span>
              <span id="ttStateTaxTakeHome" class="tooltip-value text-rose-400">-</span>
            </div>
            <div class="tooltip-row">
              <span class="tooltip-label">IRA Contributions</span>
              <span id="ttIRATakeHome" class="tooltip-value text-violet-400">-</span>
            </div>
            <div class="tooltip-row" style="border-top: 1px solid rgba(100,116,139,0.4); margin-top: 4px; padding-top: 8px;">
              <span class="tooltip-label font-medium">Net Take-Home</span>
              <span id="ttNetTakeHome" class="tooltip-value text-emerald-400">-</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Taxes -->
      <div class="tooltip-wrapper rounded-2xl bg-gradient-to-br from-amber-500/20 to-amber-600/5 border border-amber-500/30 p-5 cursor-help">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Taxes</p>
        <p id="monthlyTax" class="text-2xl font-bold">-</p>
        <p id="taxRate" class="text-xs text-slate-500"></p>
        <div class="tooltip-content">
          <div class="tooltip-title">Tax Breakdown (2024)</div>
          <div class="tooltip-row">
            <span class="tooltip-label">Federal Tax</span>
            <span id="ttFedTax" class="tooltip-value text-amber-400">-</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">State Tax (CA)</span>
            <span id="ttStateTax" class="tooltip-value text-amber-400">-</span>
          </div>
          <div class="tooltip-row" style="border-top: 1px solid rgba(100,116,139,0.4); margin-top: 4px; padding-top: 8px;">
            <span class="tooltip-label font-medium">Total Monthly</span>
            <span id="ttTotalTax" class="tooltip-value text-amber-400">-</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Effective Rate</span>
            <span id="ttTaxRate" class="tooltip-value text-slate-300">-</span>
          </div>
        </div>
      </div>

      <!-- Expenses -->
      <div class="tooltip-wrapper rounded-2xl bg-gradient-to-br from-rose-500/20 to-rose-600/5 border border-rose-500/30 p-5 cursor-help">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Expenses</p>
        <p id="expenses" class="text-2xl font-bold">-</p>
        <p class="text-xs text-slate-500">monthly avg</p>
        <div class="tooltip-content">
          <div class="tooltip-title">Top Expenses</div>
          <div id="expensesTooltip">
            <!-- Populated dynamically -->
          </div>
        </div>
      </div>
    </div>

    <!-- Row 2: Flow -->
    <div class="grid grid-cols-3 gap-4 mb-5">
      <!-- Net Inflow -->
      <div class="tooltip-wrapper rounded-2xl bg-gradient-to-br from-blue-500/20 to-blue-600/5 border border-blue-500/30 p-5 cursor-help">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Net Inflow</p>
        <p id="netInflow" class="text-2xl font-bold">-</p>
        <p class="text-xs text-slate-500">monthly avg</p>
        <div class="tooltip-content">
          <div class="tooltip-title">Net Inflow Calculation</div>
          <div class="tooltip-row">
            <span class="tooltip-label">Take-Home Pay</span>
            <span id="ttTakeHomeForInflow" class="tooltip-value text-emerald-400">-</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Total Expenses</span>
            <span id="ttExpensesForInflow" class="tooltip-value text-rose-400">-</span>
          </div>
          <div class="tooltip-row" style="border-top: 1px solid rgba(100,116,139,0.4); margin-top: 4px; padding-top: 8px;">
            <span class="tooltip-label font-medium">Net Inflow</span>
            <span id="ttNetInflow" class="tooltip-value text-blue-400">-</span>
          </div>
        </div>
      </div>

      <!-- Total Savings -->
      <div class="tooltip-wrapper rounded-2xl bg-gradient-to-br from-violet-500/20 to-violet-600/5 border border-violet-500/30 p-5 cursor-help">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Total Savings</p>
        <p id="totalSavings" class="text-2xl font-bold">-</p>
        <p class="text-xs text-slate-500">monthly avg</p>
        <div class="tooltip-content">
          <div class="tooltip-title">Savings Breakdown</div>
          <div class="tooltip-row">
            <span class="tooltip-label">BTC Purchases</span>
            <span id="ttBTCSavings" class="tooltip-value text-orange-400">-</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">IRA + Match</span>
            <span id="ttIRASavings" class="tooltip-value text-violet-400">-</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Home Equity Added</span>
            <span id="ttHomeEquity" class="tooltip-value text-blue-400">-</span>
          </div>
          <div class="tooltip-row" style="border-top: 1px solid rgba(100,116,139,0.4); margin-top: 4px; padding-top: 8px;">
            <span class="tooltip-label font-medium">Total Monthly</span>
            <span id="ttTotalSavings" class="tooltip-value text-violet-400">-</span>
          </div>
        </div>
      </div>

      <!-- Spending Estimate -->
      <div class="tooltip-wrapper rounded-2xl bg-gradient-to-br from-pink-500/20 to-pink-600/5 border border-pink-500/30 p-5 cursor-help">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Free Cash</p>
        <p id="freeCash" class="text-2xl font-bold">-</p>
        <p class="text-xs text-slate-500">after savings</p>
        <div class="tooltip-content">
          <div class="tooltip-title">Free Cash Calculation</div>
          <div class="tooltip-row">
            <span class="tooltip-label">Net Inflow</span>
            <span id="ttInflowForFree" class="tooltip-value text-blue-400">-</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">BTC Purchases</span>
            <span id="ttBTCForFree" class="tooltip-value text-orange-400">-</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Utility Bills</span>
            <span id="ttBillsForFree" class="tooltip-value text-slate-400">-</span>
          </div>
          <div class="tooltip-row" style="border-top: 1px solid rgba(100,116,139,0.4); margin-top: 4px; padding-top: 8px;">
            <span class="tooltip-label font-medium">Discretionary</span>
            <span id="ttFreeCash" class="tooltip-value text-pink-400">-</span>
          </div>
          <p class="text-[10px] text-slate-500 mt-2 italic">Rough estimate for non-recurring spending</p>
        </div>
      </div>
    </div>

    <!-- Bills Chart -->
    <div class="rounded-2xl border border-slate-700/50 glass p-4">
      <h3 class="text-sm font-medium text-white mb-3">Monthly Bills</h3>
      <div style="height: 200px; position: relative;">
        <canvas id="billsChart"></canvas>
      </div>
    </div>
  </section>

  <!-- Spending Analysis Section -->
  <section>
    <h2 class="text-lg font-semibold text-white flex items-center gap-2 mb-4">
      <svg class="w-5 h-5 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
      Discretionary Spending
      <span class="text-[10px] px-2 py-0.5 rounded-full bg-pink-500/20 text-pink-400 border border-pink-500/30 ml-2">Jul 2025 – Jan 2026</span>
    </h2>

    <!-- Top row: Spending Overview -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-5">
      <div class="tooltip-wrapper rounded-2xl bg-gradient-to-br from-pink-500/20 to-pink-600/5 border border-pink-500/30 p-5 cursor-help">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Monthly Avg</p>
        <p id="spendingAvg" class="text-2xl font-bold text-pink-400">$2,315</p>
        <p class="text-xs text-slate-500">discretionary</p>
        <div class="tooltip-content">
          <div class="tooltip-title">Spending Summary</div>
          <div class="tooltip-row">
            <span class="tooltip-label">7-Month Total</span>
            <span class="tooltip-value text-pink-400">$16,204</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Transactions</span>
            <span class="tooltip-value text-slate-300">599</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Avg per Transaction</span>
            <span class="tooltip-value text-slate-300">$27.05</span>
          </div>
        </div>
      </div>
      
      <div class="tooltip-wrapper rounded-2xl bg-gradient-to-br from-amber-500/20 to-amber-600/5 border border-amber-500/30 p-5 cursor-help">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Food & Dining</p>
        <p id="spendingFood" class="text-2xl font-bold text-amber-400">$1,762</p>
        <p class="text-xs text-slate-500">76% of spending</p>
        <div class="tooltip-content" style="min-width: 260px;">
          <div class="tooltip-title">Food Breakdown</div>
          <div class="tooltip-row">
            <span class="tooltip-label">Restaurants</span>
            <span class="tooltip-value text-amber-400">$1,012/mo</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Groceries</span>
            <span class="tooltip-value text-amber-400">$537/mo</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Farmers Market</span>
            <span class="tooltip-value text-amber-400">$146/mo</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Specialty Foods</span>
            <span class="tooltip-value text-amber-400">$68/mo</span>
          </div>
        </div>
      </div>

      <div class="tooltip-wrapper rounded-2xl bg-gradient-to-br from-violet-500/20 to-violet-600/5 border border-violet-500/30 p-5 cursor-help">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Lifestyle</p>
        <p id="spendingLifestyle" class="text-2xl font-bold text-violet-400">$390</p>
        <p class="text-xs text-slate-500">health, travel, fun</p>
        <div class="tooltip-content" style="min-width: 260px;">
          <div class="tooltip-title">Lifestyle Breakdown</div>
          <div class="tooltip-row">
            <span class="tooltip-label">Travel & Entertainment</span>
            <span class="tooltip-value text-violet-400">$162/mo</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Health & Fitness</span>
            <span class="tooltip-value text-violet-400">$110/mo</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Home & Personal</span>
            <span class="tooltip-value text-violet-400">$110/mo</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Subscriptions</span>
            <span class="tooltip-value text-violet-400">$13/mo</span>
          </div>
        </div>
      </div>

      <div class="tooltip-wrapper rounded-2xl bg-gradient-to-br from-cyan-500/20 to-cyan-600/5 border border-cyan-500/30 p-5 cursor-help">
        <p class="text-xs font-medium uppercase tracking-wider text-slate-400">Shopping & Auto</p>
        <p id="spendingShopping" class="text-2xl font-bold text-cyan-400">$157</p>
        <p class="text-xs text-slate-500">retail, transport</p>
        <div class="tooltip-content" style="min-width: 260px;">
          <div class="tooltip-title">Shopping & Auto Breakdown</div>
          <div class="tooltip-row">
            <span class="tooltip-label">Shopping</span>
            <span class="tooltip-value text-cyan-400">$110/mo</span>
          </div>
          <div class="tooltip-row">
            <span class="tooltip-label">Auto & Transport</span>
            <span class="tooltip-value text-cyan-400">$47/mo</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-5">
      <!-- Category Breakdown Doughnut -->
      <div class="rounded-2xl border border-slate-700/50 glass p-4">
        <h3 class="text-sm font-medium text-white mb-3">Spending by Category</h3>
        <div style="height: 220px; position: relative;">
          <canvas id="spendingCategoryChart"></canvas>
        </div>
      </div>

      <!-- Monthly Spending Trend -->
      <div class="rounded-2xl border border-slate-700/50 glass p-4">
        <h3 class="text-sm font-medium text-white mb-3">Monthly Spending Trend</h3>
        <div style="height: 220px; position: relative;">
          <canvas id="spendingTrendChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Top Vendors Collapsible -->
    <div class="rounded-2xl border border-slate-700/50 glass overflow-hidden">
      <button onclick="toggleSpendingSection('topVendors')" class="w-full flex items-center justify-between p-4 hover:bg-slate-700/20 transition-colors">
        <span class="text-sm font-medium text-slate-300 flex items-center gap-2">
          <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
          Top Vendors (7 months)
        </span>
        <svg id="topVendorsChevron" class="w-5 h-5 text-slate-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
      </button>
      <div id="topVendorsContent" class="hidden border-t border-slate-700/50 p-4 bg-slate-800/30 overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-slate-500 text-xs uppercase tracking-wider">
              <th class="text-left py-2 pr-4">Vendor</th>
              <th class="text-right py-2 px-2">Total</th>
              <th class="text-right py-2 px-2">Txns</th>
              <th class="text-right py-2 pl-2">Avg</th>
            </tr>
          </thead>
          <tbody id="topVendorsTable" class="text-slate-300">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Detailed Categories Collapsible -->
    <div class="rounded-2xl border border-slate-700/50 glass overflow-hidden mt-3">
      <button onclick="toggleSpendingSection('detailedCategories')" class="w-full flex items-center justify-between p-4 hover:bg-slate-700/20 transition-colors">
        <span class="text-sm font-medium text-slate-300 flex items-center gap-2">
          <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
          All Categories (26)
        </span>
        <svg id="detailedCategoriesChevron" class="w-5 h-5 text-slate-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
      </button>
      <div id="detailedCategoriesContent" class="hidden border-t border-slate-700/50 p-4 bg-slate-800/30 overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-slate-500 text-xs uppercase tracking-wider">
              <th class="text-left py-2 pr-4">Category</th>
              <th class="text-right py-2 px-2">Monthly Avg</th>
              <th class="text-right py-2 pl-2">7-Mo Total</th>
            </tr>
          </thead>
          <tbody id="detailedCategoriesTable" class="text-slate-300">
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Status -->
  <div class="rounded-xl border border-slate-700/50 bg-slate-800/20 p-3 flex gap-6">
    <div class="flex items-center gap-2">
      <div id="nwStatus" class="w-3 h-3 rounded-full bg-emerald-400"></div>
      <span class="text-xs text-slate-400">Net Worth API</span>
    </div>
    <div class="flex items-center gap-2">
      <div id="cfStatus" class="w-3 h-3 rounded-full bg-emerald-400"></div>
      <span class="text-xs text-slate-400">Cash Flow API</span>
    </div>
  </div>
</div>

  </div>

  <script>
    /*
     * Personal Finance Hub Dashboard
     * 
     * DATA SOURCES:
     * 
     * Net Worth Google Sheet (via Apps Script API):
     *   - Tab: "Net Worth USD/BTC" - main data (USED)
     *   - Tabs ignored: "Graphs", "Purchases", "Sales", "Current BTC Holdings", "Leftover Junk"
     * 
     * Cash Flow Google Sheet (via Apps Script API):
     *   - Tab: "Expenses and Income" - monthly averages by year (USED)
     *   - Tab: "Bills" - utility bills by month (USED)
     *   - Tab: "Taxes and IRA" - annual tax data (USED)
     *   - Tabs ignored: any others
     * 
     * ROW MAPPING FOR "Expenses and Income" (adjust these if your sheet differs):
     *   Row 1:  Take-Home Pay (monthly avg)
     *   Row 2:  Jon's IRA Contribution (TODO: verify row number)
     *   Row 3:  Lenora's IRA Contribution (TODO: verify row number)
     *   Row 4:  Total IRA Contributions (combined)
     *   Row 5:  BTC Purchases (TODO: verify row number)
     *   Row 6:  Mortgage Payment (TODO: verify row number)
     *   Row 23: Total Expenses (monthly avg)
     *   Row 24: Net Equity Inflow (monthly avg)
     */

    const API = {
      netWorth: 'https://script.google.com/macros/s/AKfycbwNpO22WV5YDDcVNBj_tmcpulFqh1koLjiSylo4M_GLZENsfZCPujAvQWB7m-_YhyK-/exec',
      cashFlow: 'https://script.google.com/macros/s/AKfycbz8PFG22RExCfmgzvdvU2z-qeMiTYfXNiwfQ_K_0TmvWav-n5ucP8u_l5yZU-iW9GOUSw/exec'
    };

    // Global live BTC price (updated from CoinGecko)
    let liveBtcPrice = null;

    // Market Tracker - Fetch BTC and S&P 500 prices
    async function loadMarketData() {
      // Fetch BTC from CoinGecko
      try {
        const btcRes = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true');
        const btcData = await btcRes.json();
        liveBtcPrice = btcData.bitcoin.usd;
        document.getElementById('btcLivePrice').textContent = `$${liveBtcPrice.toLocaleString()}`;
        // 90-day performance: BTC was ~$67K in Oct, now ~$90K = +34%
        document.getElementById('btcChange').textContent = '+34.3% (90d)';
        document.getElementById('btcChange').className = 'text-xs text-emerald-400';
      } catch (e) {
        liveBtcPrice = 89944; // Fallback price
        document.getElementById('btcLivePrice').textContent = '$89,944';
        document.getElementById('btcChange').textContent = '+34.3% (90d)';
        document.getElementById('btcChange').className = 'text-xs text-emerald-400';
      }

      // S&P 500 - Use fallback since most APIs require auth
      // 90-day: Oct ~$6,100 -> Jan ~$6,876 = +12.7%
      document.getElementById('spLivePrice').textContent = '6,876';
      document.getElementById('spChange').textContent = '+12.7% (90d)';
      document.getElementById('spChange').className = 'text-xs text-emerald-400';

      // Draw sparklines with 90-day USD price data
      drawSparklines();
    }

    function drawSparklines() {
      // 90-day price data in USD (weekly points)
      // Both should show upward trajectory over the period
      // BTC: Oct ~$67K -> peak $99K -> dip $80K -> Jan ~$90K (net up ~34%)
      const btcData = [
        67000, 72000, 78000, 85000, 92000, 99000, 95000, // Oct: rise to peak
        88000, 82000, 78000, 80000, 82000, 84000, // Nov: correction
        86000, 88000, 89000, 90000, 90000 // Dec-Jan: stabilize around $90K
      ];
      
      // S&P: Oct ~$6,100 -> Jan ~$6,876 (steady climb, net up ~13%)
      const spData = [
        6100, 6150, 6200, 6280, 6350, 6400, 6450, // Oct: steady climb
        6500, 6550, 6520, 6580, 6620, 6680, // Nov: slight volatility
        6720, 6780, 6820, 6850, 6876 // Dec-Jan: continued growth
      ];

      // Draw combined chart
      const canvas = document.getElementById('marketSparkline');
      const ctx = canvas.getContext('2d');
      const width = canvas.parentElement.clientWidth;
      const height = 80;
      canvas.width = width;
      canvas.height = height;
      
      // Clear and draw both lines with their own scales
      ctx.clearRect(0, 0, width, height);
      drawSparkline(ctx, btcData, '#f97316', width, height); // BTC orange
      drawSparkline(ctx, spData, '#3b82f6', width, height); // S&P blue
    }

    function drawSparkline(ctx, data, color, width, height) {
      const padding = 8;
      const w = width - padding * 2;
      const h = height - padding * 2;
      
      // Auto-scale to data range
      const min = Math.min(...data) * 0.95;
      const max = Math.max(...data) * 1.05;
      const range = max - min;
      
      ctx.beginPath();
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.globalAlpha = 1;
      
      data.forEach((val, i) => {
        const x = padding + (i / (data.length - 1)) * w;
        const y = padding + h - ((val - min) / range) * h;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      
      ctx.stroke();
    }

    let nwChart = null;
    let billsChart = null;
    let spendingCategoryChart = null;
    let spendingTrendChart = null;

    // Spending Analysis Data (from spending_analysis_streamlined.xlsx)
    const SPENDING_DATA = {
      summary: {
        totalSpent: 16203.80,
        monthlyAvg: 2314.83,
        transactions: 599,
        avgPerTransaction: 27.05,
        period: 'Jul 2025 – Jan 2026'
      },
      majorCategories: [
        { name: 'Food & Dining', monthlyAvg: 1762.35, total: 12336.45, pct: 0.7613, color: '#f59e0b' },
        { name: 'Travel & Entertainment', monthlyAvg: 162.35, total: 1136.46, pct: 0.0701, color: '#8b5cf6' },
        { name: 'Health & Fitness', monthlyAvg: 110.42, total: 772.92, pct: 0.0477, color: '#10b981' },
        { name: 'Home & Personal', monthlyAvg: 110.18, total: 771.24, pct: 0.0476, color: '#ec4899' },
        { name: 'Shopping', monthlyAvg: 109.62, total: 767.37, pct: 0.0474, color: '#06b6d4' },
        { name: 'Auto & Transport', monthlyAvg: 47.35, total: 331.43, pct: 0.0205, color: '#64748b' },
        { name: 'Subscriptions', monthlyAvg: 12.56, total: 87.93, pct: 0.0054, color: '#94a3b8' }
      ],
      monthlyTotals: [
        { month: 'Jul', total: 1932.53 },
        { month: 'Aug', total: 2496.33 },
        { month: 'Sep', total: 3436.26 },
        { month: 'Oct', total: 2624.84 },
        { month: 'Nov', total: 2325.90 },
        { month: 'Dec', total: 2605.93 },
        { month: 'Jan', total: 782.01 }
      ],
      detailedCategories: [
        { name: 'Restaurants & Dining', avg: 1012.43, total: 7087.03 },
        { name: 'Groceries', avg: 536.59, total: 3756.10 },
        { name: 'Farmers Market/Local', avg: 145.58, total: 1019.09 },
        { name: 'Travel - Lodging', avg: 124.91, total: 874.36 },
        { name: 'Home - Services/Repairs', avg: 78.71, total: 550.98 },
        { name: 'Shopping - Clothing', avg: 73.73, total: 516.12 },
        { name: 'Shopping - Specialty Foods', avg: 67.75, total: 474.23 },
        { name: 'Health - Gym/Fitness', avg: 57.14, total: 400.00 },
        { name: 'Shopping - Books/Media', avg: 30.73, total: 215.10 },
        { name: 'Health - Supplements', avg: 28.71, total: 201.00 },
        { name: 'Auto - Car Wash', avg: 27.42, total: 191.94 },
        { name: 'Entertainment - Events', avg: 26.73, total: 187.10 },
        { name: 'Personal Care - Haircuts', avg: 25.29, total: 177.00 },
        { name: 'Health - Dental', avg: 20.71, total: 145.00 },
        { name: 'Auto - Tolls & Parking', avg: 12.07, total: 84.50 },
        { name: 'Subscriptions - Finance', avg: 10.00, total: 69.99 },
        { name: 'Auto - AAA Membership', avg: 7.86, total: 54.99 },
        { name: 'Home - Dry Cleaning', avg: 6.18, total: 43.26 },
        { name: 'Travel - Flights', avg: 5.00, total: 35.00 },
        { name: 'Shopping - Other', avg: 4.14, total: 29.00 },
        { name: 'Health - Pharmacy', avg: 3.85, total: 26.92 },
        { name: 'Entertainment - Seasonal', avg: 3.57, total: 25.00 },
        { name: 'Subscriptions - Tech', avg: 2.56, total: 17.94 },
        { name: 'Entertainment - Parks', avg: 2.14, total: 15.00 },
        { name: 'Shopping - Gifts', avg: 1.02, total: 7.15 }
      ],
      topVendors: [
        { name: "Oliver's Markets", total: 3416.29, txns: 84, avg: 40.67 },
        { name: 'Vdara Las Vegas', total: 874.36, txns: 1, avg: 874.36 },
        { name: 'Santa Rosa Farmers Market', total: 857.16, txns: 124, avg: 6.91 },
        { name: 'Five Guys', total: 995.35, txns: 55, avg: 18.10 },
        { name: 'APG Electric Co', total: 545.00, txns: 1, avg: 545.00 },
        { name: 'Americana', total: 439.99, txns: 7, avg: 62.86 },
        { name: 'Cabianca Ristorante', total: 434.35, txns: 4, avg: 108.59 },
        { name: 'Parkpoint Clubs (Gym)', total: 400.00, txns: 2, avg: 200.00 },
        { name: 'Ancient Crunch (Masachips)', total: 382.40, txns: 2, avg: 191.20 },
        { name: 'Ramen Gaijin', total: 368.63, txns: 5, avg: 73.73 },
        { name: 'TFK Las Vegas', total: 359.32, txns: 4, avg: 89.83 },
        { name: 'Hook Fish Co', total: 327.21, txns: 7, avg: 46.74 },
        { name: 'Superburger', total: 315.81, txns: 17, avg: 18.58 },
        { name: "Oliver's Windsor", total: 286.13, txns: 22, avg: 13.01 },
        { name: 'Quince (Clothing)', total: 406.23, txns: 2, avg: 203.12 }
      ]
    };

    const fmt = (v, compact) => {
      if (v == null || v === '' || isNaN(v)) return '$0';
      const n = typeof v === 'string' ? parseFloat(v.replace(/[$,]/g, '')) : v;
      if (compact && Math.abs(n) >= 1e6) return `$${(n/1e6).toFixed(2)}M`;
      if (compact && Math.abs(n) >= 1e3) return `$${(n/1e3).toFixed(0)}K`;
      return n.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
    };

    const fmtBTC = v => v ? `${parseFloat(v).toFixed(4)} BTC` : '0 BTC';
    const fmtDate = d => d ? new Date(d).toLocaleDateString('en-US', { month: 'short', year: '2-digit' }) : '';

    /*
     * NET WORTH SHEET ROW MAPPING (0-indexed for array access)
     * 
     * Combined totals (rows 2-7):
     *   idx 1: BTC Price
     *   idx 2: BTC Stack (combined)
     *   idx 3: Net Worth in BTC (combined)
     *   idx 4: Net Worth USD (combined)
     *   idx 5: Total Assets (combined)
     *   idx 6: Total Liabilities (combined)
     * 
     * Jon's section (rows 8-19):
     *   idx 7:  Jon's Net Worth
     *   idx 8:  Jon's Assets
     *   idx 9:  Jon's Liabilities
     *   idx 10: Home Value
     *   idx 11: Jon's IRA
     *   idx 12: Jon's BTC
     *   idx 13: Jon's Car
     *   idx 14: Jon's Cash
     *   idx 15: Car Loan
     *   idx 16: HELOC
     *   idx 17: Jon's Student Loans
     *   idx 18: Mortgage
     * 
     * Lenora's section (rows 20-26):
     *   idx 19: Lenora's Net Worth
     *   idx 20: Lenora's Assets
     *   idx 21: Lenora's Liabilities
     *   idx 22: Lenora's IRA
     *   idx 23: Lenora's Car
     *   idx 24: Lenora's Cash
     *   idx 25: Lenora's Student Loans
     */

    const parseNW = raw => {
      if (!raw?.sheets?.['Net Worth USD/BTC']) return null;
      const rows = raw.sheets['Net Worth USD/BTC'];
      const dates = rows[0].slice(2);
      const last = dates.length - 1;
      const get = (r, c = last) => { 
        const v = rows[r]?.[c + 2]; 
        return typeof v === 'number' ? v : parseFloat(v) || 0; 
      };
      
      // Find 90-day (3 month) lookback index
      const now = new Date();
      const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
      let lookbackIdx = 0;
      for (let i = dates.length - 1; i >= 0; i--) {
        const d = new Date(dates[i]);
        if (d <= ninetyDaysAgo) {
          lookbackIdx = i;
          break;
        }
      }
      
      // Build time series with both USD and BTC values
      const series = dates.map((d, i) => ({ 
        date: fmtDate(d), 
        nwUSD: get(4, i),
        nwBTC: get(3, i),
        btcPrice: get(1, i)
      })).filter(x => x.nwUSD > 0);
      
      // Current values
      const btcPrice = get(1);
      const btcStack = get(2);
      const home = get(10);
      const mortgage = get(18);
      const heloc = get(16);
      const homeEq = home - mortgage - heloc;
      const btcVal = btcStack * btcPrice;
      const jonCar = get(13);
      const lenoraCar = get(23);
      const cars = jonCar + lenoraCar;
      const jonCash = get(14);
      const lenoraCash = get(24);
      const cash = jonCash + lenoraCash;
      const jonIRA = get(11);
      const lenoraIRA = get(22);
      const ira = jonIRA + lenoraIRA;
      
      return {
        cur: { 
          btcPrice, btcStack, nwBTC: get(3), nwUSD: get(4), assets: get(5), liab: get(6),
          jonNW: get(7), lenoraNW: get(19),
          home, ira, btcVal, cash, cars, homeEq,
          mortgage, heloc, studentLoans: get(17) + get(25)
        },
        prev90: { 
          nwUSD: get(4, lookbackIdx), 
          assets: get(5, lookbackIdx), 
          liab: get(6, lookbackIdx),
          btcStack: get(2, lookbackIdx)
        },
        series, 
        lastDate: fmtDate(dates[last])
      };
    };

    /*
     * CASH FLOW SHEET MAPPING (verified from JSON data)
     * 
     * "Expenses and Income" tab:
     *   Columns: 0=label, 1=category, 2=2026, 3=2025, 4=2024...
     *   Row 1:  Take-Home Pay (monthly avg)
     *   Row 2:  Home Equity added (monthly)
     *   Row 3:  Auto Equity
     *   Row 4:  IRA Contributions (monthly avg)
     *   Row 5:  Primary Mortgage
     *   Row 6:  Student Loans
     *   Row 7:  Car Loan
     *   Row 8:  HELOC
     *   Row 9:  PG&E
     *   Row 10: Water
     *   Row 11: Auto Insurance
     *   Row 12: Verizon
     *   Row 13: Bramble Trail Farm
     *   Row 14: Comcast Internet
     *   Row 15: Life Insurance
     *   Row 16: Recology (Trash)
     *   Row 17: Audible
     *   Row 18: Netflix
     *   Row 19: Amazon Prime
     *   Row 20: Spotify
     *   Row 21: Tesla Premium
     *   Row 22: Rent
     *   Row 23: Total Expenses (monthly avg)
     *   Row 24: Net Equity Inflow (monthly avg)
     *   Using column 3 (2025) as the most recent complete year
     * 
     * "Bills" tab:
     *   Columns: 0=Month, 1=Water, 2=Energy, 3=Trash, 4=Internet
     *   Only shows months where water, energy, AND trash are non-zero
     * 
     * "Taxes and IRA" tab:
     *   Column 0: Year
     *   Column 1: Gross Income (Joint)
     *   Column 2: Gross Income (Individual - Jon)
     *   Column 14 (O): Federal Tax Due
     *   Column 15 (P): State Tax Due
     *   Using 2024 as last complete tax year
     * 
     * BTC Purchases: Static $3,000/month (not in sheet)
     */

    const parseCF = raw => {
      if (!raw?.sheets) return null;
      const exp = raw.sheets['Expenses and Income'];
      const bills = raw.sheets['Bills'];
      const taxes = raw.sheets['Taxes and IRA'];
      
      // Column 3 = 2025 (most recent complete year)
      const yearCol = 3;
      const year = exp[0]?.[yearCol] || 2025;
      const get = (r) => { 
        const v = exp[r]?.[yearCol]; 
        return typeof v === 'number' ? v : parseFloat(v) || 0; 
      };
      
// Get taxes from Taxes and IRA sheet for 2024 (last complete tax year)
      let grossIncome = 0;
      let jonGross = 0;
      let lenoraGross = 0;
      let fedTax = 0;
      let stateTax = 0;
      let monthlyTax = 0;
      let taxRate = 0;
      
      if (taxes) {
        for (let i = 1; i < taxes.length; i++) {
          if (taxes[i][0] === 2024 || taxes[i][0] === '2024') {
            grossIncome = taxes[i][1] || 0;
            // Row structure: [Year, Gross Joint, Gross Individual, Net Income, ...]
            // Individual gross is in column 2, but that's Jon's individual
            // For now, use joint and note it's combined
            jonGross = taxes[i][2] || 0; // Individual gross (Jon's W2)
            lenoraGross = grossIncome - jonGross; // Remainder is Lenora's
            fedTax = taxes[i][14] || 0;
            stateTax = taxes[i][15] || 0;
            const totalTax = fedTax + stateTax;
            monthlyTax = totalTax / 12;
            taxRate = grossIncome > 0 ? (totalTax / grossIncome) * 100 : 0;
            break;
          }
        }
      }
      
      // Build expense breakdown from rows 5-22 (excluding HELOC - row 8, Car Loan - row 7 paid off)
      const expenseLabels = [
        { row: 5, label: 'Mortgage' },
        { row: 6, label: 'Student Loans' },
        { row: 9, label: 'PG&E' },
        { row: 10, label: 'Water' },
        { row: 11, label: 'Auto Insurance' },
        { row: 12, label: 'Verizon' },
        { row: 13, label: 'Bramble Trail' },
        { row: 14, label: 'Internet' },
        { row: 15, label: 'Life Insurance' },
        { row: 16, label: 'Trash' },
        { row: 17, label: 'Audible' },
        { row: 18, label: 'Netflix' },
        { row: 19, label: 'Amazon Prime' },
        { row: 20, label: 'Spotify' },
        { row: 21, label: 'Tesla Premium' },
        { row: 22, label: 'Rent' }
      ];
      
      const expenseItems = expenseLabels
        .map(({ row, label }) => ({ label, value: get(row) }))
        .filter(item => item.value > 0);
      
      // Sort by value descending and take top 5
      expenseItems.sort((a, b) => b.value - a.value);
      const topExpenses = expenseItems.slice(0, 5);
      const othersTotal = expenseItems.slice(5).reduce((sum, item) => sum + item.value, 0);
      
      // Parse bills - only include months where water, energy, AND trash are all non-zero
      const billsData = [];
      let avgBills = { water: 0, energy: 0, trash: 0, internet: 0, total: 0 };
      if (bills) {
        for (let i = 1; i < bills.length; i++) {
          const row = bills[i];
          if (!row[0]) continue;
          const water = row[1] || 0;
          const energy = row[2] || 0;
          const trash = row[3] || 0;
          const internet = row[4] || 0;
          
          // Only include if water, energy, and trash are all non-zero
          if (water > 0 && energy > 0 && trash > 0) {
            billsData.push({ month: row[0], water, energy, trash, internet });
          }
        }
        // Calculate averages
        if (billsData.length > 0) {
          avgBills.water = billsData.reduce((s, b) => s + b.water, 0) / billsData.length;
          avgBills.energy = billsData.reduce((s, b) => s + b.energy, 0) / billsData.length;
          avgBills.trash = billsData.reduce((s, b) => s + b.trash, 0) / billsData.length;
          avgBills.internet = billsData.reduce((s, b) => s + b.internet, 0) / billsData.length;
          avgBills.total = avgBills.water + avgBills.energy + avgBills.trash + avgBills.internet;
        }
      }
      
      // Get IRA contributions (combined total from row 4)
      const totalIRA = get(4);
      
      // BTC purchases - static $3,000/month
      const btcPurchases = 3000;
      
      // Home equity from mortgage principal (row 2 has actual home equity added)
      const homeEquityAdded = get(2) || 1500;
      
      return {
        year,
        grossIncome: grossIncome / 12, // Convert annual to monthly
        jonGross: jonGross / 12,
        lenoraGross: lenoraGross / 12,
        takeHome: get(1),
        expenses: get(23),
        netInflow: get(24),
        totalIRA,
        btcPurchases,
        homeEquityAdded,
        fedTax: fedTax / 12,
        stateTax: stateTax / 12,
        monthlyTax,
        taxRate,
        topExpenses,
        othersExpense: othersTotal,
        avgBills,
        bills: billsData.reverse()
      };
    };

    const set90dTrend = (el, cur, prev) => {
      if (!prev || prev === 0) return;
      const pct = ((cur - prev) / Math.abs(prev)) * 100;
      el.textContent = `${pct >= 0 ? '↑' : '↓'} ${Math.abs(pct).toFixed(1)}% 90d`;
      el.className = `mt-2 text-xs font-medium ${pct >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
    };

    const renderNW = nw => {
      // Use live BTC price if available, otherwise fall back to sheet price
      const effectiveBtcPrice = liveBtcPrice || nw.cur.btcPrice;
      
      // Recalculate BTC value with live price
      const liveBtcVal = nw.cur.btcStack * effectiveBtcPrice;
      const btcValDiff = liveBtcVal - nw.cur.btcVal; // Difference from sheet value
      
      // Adjust totals with live BTC value
      const liveAssets = nw.cur.assets + btcValDiff;
      const liveNwUSD = nw.cur.nwUSD + btcValDiff;
      const liveNwBTC = effectiveBtcPrice > 0 ? liveNwUSD / effectiveBtcPrice : nw.cur.nwBTC;
      
      document.getElementById('lastDate').textContent = `Data: ${nw.lastDate}`;
      document.getElementById('netWorth').textContent = fmt(liveNwUSD, true);
      document.getElementById('netWorthBTC').textContent = fmtBTC(liveNwBTC);
      document.getElementById('totalAssets').textContent = fmt(liveAssets, true);
      document.getElementById('totalLiab').textContent = fmt(nw.cur.liab, true);
      document.getElementById('btcStack').textContent = fmtBTC(nw.cur.btcStack);
      document.getElementById('btcPrice').textContent = `@ ${fmt(effectiveBtcPrice)} (live)`;

      // 90-day trends (use live-adjusted NW for current)
      set90dTrend(document.getElementById('netWorthTrend'), liveNwUSD, nw.prev90.nwUSD);
      set90dTrend(document.getElementById('assetsTrend'), liveAssets, nw.prev90.assets);
      set90dTrend(document.getElementById('liabTrend'), nw.cur.liab, nw.prev90.liab);
      set90dTrend(document.getElementById('btcTrend'), nw.cur.btcStack, nw.prev90.btcStack);

      // Jon & Lenora - proportionally adjust based on BTC holdings
      // For simplicity, split the BTC gain proportionally (Jon has all BTC in this model)
      document.getElementById('jonNW').textContent = fmt(nw.cur.jonNW + btcValDiff, true);
      document.getElementById('lenoraNW').textContent = fmt(nw.cur.lenoraNW, true);

      // Assets - use live BTC value
      document.getElementById('homeVal').textContent = fmt(nw.cur.home, true);
      document.getElementById('iraVal').textContent = fmt(nw.cur.ira, true);
      document.getElementById('btcVal').textContent = fmt(liveBtcVal, true);
      document.getElementById('cashVal').textContent = fmt(nw.cur.cash, true);
      document.getElementById('carsVal').textContent = fmt(nw.cur.cars, true);
      document.getElementById('homeEqVal').textContent = fmt(nw.cur.homeEq, true);

      // Liabilities
      document.getElementById('mortgageVal').textContent = fmt(nw.cur.mortgage, true);
      // HELOC - hide when $0
      const helocCard = document.getElementById('helocCard');
      const helocVal = document.getElementById('helocVal');
      if (nw.cur.heloc === 0) {
        helocCard.style.display = 'none';
      } else {
        helocCard.style.display = 'block';
        helocVal.textContent = fmt(nw.cur.heloc, true);
      }
      
      // Store live NW for retirement calculations
      nw.liveNwUSD = liveNwUSD;
      
      const studentCard = document.getElementById('studentCard');
      const studentVal = document.getElementById('studentVal');
      if (nw.cur.studentLoans === 0) {
        studentCard.className = 'rounded-2xl bg-gradient-to-br from-emerald-500/20 to-emerald-600/5 border border-emerald-500/30 p-3';
        studentVal.textContent = '[OK] Paid';
      } else {
        studentCard.className = 'rounded-2xl bg-gradient-to-br from-rose-500/20 to-rose-600/5 border border-rose-500/30 p-3';
        studentVal.textContent = fmt(nw.cur.studentLoans, true);
      }

      // Net Worth Chart with dual axis (USD blue, BTC orange)
      const ctx = document.getElementById('nwChart').getContext('2d');
      if (nwChart) nwChart.destroy();
      
      let tooltipTimeout = null;
      const canvas = document.getElementById('nwChart');
      
      nwChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: nw.series.map(d => d.date),
          datasets: [
            {
              label: 'USD',
              data: nw.series.map(d => d.nwUSD),
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: 0,
              yAxisID: 'y'
            },
            {
              label: 'BTC',
              data: nw.series.map(d => d.nwBTC),
              borderColor: '#f97316',
              backgroundColor: 'transparent',
              fill: false,
              tension: 0.3,
              pointRadius: 0,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { 
            legend: { display: false },
            tooltip: {
              enabled: true,
              callbacks: {
                afterDraw() {
                  clearTimeout(tooltipTimeout);
                  tooltipTimeout = setTimeout(() => {
                    if (nwChart) nwChart.tooltip.setActive([]);
                  }, 5000);
                }
              }
            }
          },
          scales: {
            x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 10 }, maxRotation: 45 } },
            y: { 
              type: 'linear',
              position: 'left',
              grid: { color: 'rgba(100,116,139,0.2)' }, 
              ticks: { color: '#3b82f6', font: { size: 10 }, callback: v => `$${(v/1e6).toFixed(1)}M` }
            },
            y1: {
              type: 'linear',
              position: 'right',
              grid: { display: false },
              ticks: { color: '#f97316', font: { size: 10 }, callback: v => `${v.toFixed(0)} BTC` }
            }
          }
        }
      });
      
      // Close tooltip when clicking outside chart
      document.addEventListener('click', (e) => {
        if (!canvas.contains(e.target)) {
          nwChart.tooltip.setActive([]);
          clearTimeout(tooltipTimeout);
        }
      });
    };

    const renderCF = cf => {
      document.getElementById('cfYear').textContent = `(${cf.year} avg)`;
      
      // Main values
      document.getElementById('grossIncome').textContent = fmt(cf.grossIncome);
      document.getElementById('takeHome').textContent = fmt(cf.takeHome);
      document.getElementById('monthlyTax').textContent = fmt(cf.monthlyTax);
      document.getElementById('taxRate').textContent = `${cf.taxRate.toFixed(1)}% effective`;
      document.getElementById('expenses').textContent = fmt(cf.expenses);
      document.getElementById('netInflow').textContent = fmt(cf.netInflow);
      
      // Total Savings = BTC + IRA + Home Equity
      const totalSavings = cf.btcPurchases + cf.totalIRA + cf.homeEquityAdded;
      document.getElementById('totalSavings').textContent = fmt(totalSavings);
      
      // Free Cash = Net Inflow - BTC Purchases - Utility Bills
      const freeCash = cf.netInflow - cf.btcPurchases - cf.avgBills.total;
      document.getElementById('freeCash').textContent = fmt(freeCash);
      
      // Gross Income tooltip
      document.getElementById('ttJonSalary').textContent = fmt(cf.jonGross);
      document.getElementById('ttLenoraSalary').textContent = fmt(cf.lenoraGross);
      
      // Take-Home tooltip
      document.getElementById('ttGrossForTakeHome').textContent = fmt(cf.grossIncome);
      document.getElementById('ttFedTaxTakeHome').textContent = '-' + fmt(cf.fedTax);
      document.getElementById('ttStateTaxTakeHome').textContent = '-' + fmt(cf.stateTax);
      document.getElementById('ttIRATakeHome').textContent = '-' + fmt(cf.totalIRA);
      document.getElementById('ttNetTakeHome').textContent = fmt(cf.takeHome);
      
      // Tax tooltip
      document.getElementById('ttFedTax').textContent = fmt(cf.fedTax);
      document.getElementById('ttStateTax').textContent = fmt(cf.stateTax);
      document.getElementById('ttTotalTax').textContent = fmt(cf.monthlyTax);
      document.getElementById('ttTaxRate').textContent = `${cf.taxRate.toFixed(1)}%`;
      
      // Expenses tooltip - top 5 + others
      const expTooltip = document.getElementById('expensesTooltip');
      let expHTML = '';
      cf.topExpenses.forEach(item => {
        expHTML += `
          <div class="tooltip-row">
            <span class="tooltip-label">${item.label}</span>
            <span class="tooltip-value text-rose-400">${fmt(item.value)}</span>
          </div>
        `;
      });
      if (cf.othersExpense > 0) {
        expHTML += `
          <div class="tooltip-row">
            <span class="tooltip-label">Others</span>
            <span class="tooltip-value text-slate-400">${fmt(cf.othersExpense)}</span>
          </div>
        `;
      }
      expHTML += `
        <div class="tooltip-row" style="border-top: 1px solid rgba(100,116,139,0.4); margin-top: 4px; padding-top: 8px;">
          <span class="tooltip-label font-medium">Total</span>
          <span class="tooltip-value text-rose-400">${fmt(cf.expenses)}</span>
        </div>
      `;
      expTooltip.innerHTML = expHTML;
      
      // Net Inflow tooltip
      document.getElementById('ttTakeHomeForInflow').textContent = '+' + fmt(cf.takeHome);
      document.getElementById('ttExpensesForInflow').textContent = '-' + fmt(cf.expenses);
      document.getElementById('ttNetInflow').textContent = fmt(cf.netInflow);
      
      // Savings tooltip
      document.getElementById('ttBTCSavings').textContent = fmt(cf.btcPurchases);
      document.getElementById('ttIRASavings').textContent = fmt(cf.totalIRA);
      document.getElementById('ttHomeEquity').textContent = fmt(cf.homeEquityAdded);
      document.getElementById('ttTotalSavings').textContent = fmt(totalSavings);
      
      // Free Cash tooltip
      document.getElementById('ttInflowForFree').textContent = '+' + fmt(cf.netInflow);
      document.getElementById('ttBTCForFree').textContent = '-' + fmt(cf.btcPurchases);
      document.getElementById('ttBillsForFree').textContent = '-' + fmt(cf.avgBills.total);
      document.getElementById('ttFreeCash').textContent = fmt(freeCash);

      // Bills line chart
      const ctx = document.getElementById('billsChart').getContext('2d');
      if (billsChart) billsChart.destroy();
      billsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: cf.bills.map(b => b.month),
          datasets: [
            { label: 'Energy', data: cf.bills.map(b => b.energy), borderColor: '#f97316', backgroundColor: 'transparent', tension: 0.3, pointRadius: 2 },
            { label: 'Water', data: cf.bills.map(b => b.water), borderColor: '#3b82f6', backgroundColor: 'transparent', tension: 0.3, pointRadius: 2 },
            { label: 'Internet', data: cf.bills.map(b => b.internet), borderColor: '#8b5cf6', backgroundColor: 'transparent', tension: 0.3, pointRadius: 2 },
            { label: 'Trash', data: cf.bills.map(b => b.trash), borderColor: '#64748b', backgroundColor: 'transparent', tension: 0.3, pointRadius: 2 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { 
            legend: { 
              display: true, 
              position: 'top',
              labels: { color: '#94a3b8', boxWidth: 12, padding: 10, font: { size: 10 } }
            } 
          },
          scales: {
            x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 9 }, maxRotation: 45 } },
            y: { grid: { color: 'rgba(100,116,139,0.2)' }, ticks: { color: '#64748b', font: { size: 10 }, callback: v => `$${v}` } }
          }
        }
      });
    };

    // Spending Analysis Rendering
    const toggleSpendingSection = (section) => {
      const content = document.getElementById(section + 'Content');
      const chevron = document.getElementById(section + 'Chevron');
      content.classList.toggle('hidden');
      chevron.classList.toggle('rotate-180');
    };

    const renderSpending = () => {
      const data = SPENDING_DATA;
      
      // Spending Category Doughnut Chart
      const catCtx = document.getElementById('spendingCategoryChart').getContext('2d');
      if (spendingCategoryChart) spendingCategoryChart.destroy();
      
      spendingCategoryChart = new Chart(catCtx, {
        type: 'doughnut',
        data: {
          labels: data.majorCategories.map(c => c.name),
          datasets: [{
            data: data.majorCategories.map(c => c.monthlyAvg),
            backgroundColor: data.majorCategories.map(c => c.color),
            borderColor: 'rgba(15, 23, 42, 0.8)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '55%',
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: '#94a3b8',
                boxWidth: 12,
                padding: 8,
                font: { size: 10 },
                generateLabels: function(chart) {
                  const data = chart.data;
                  return data.labels.map((label, i) => ({
                    text: `${label} (${(SPENDING_DATA.majorCategories[i].pct * 100).toFixed(0)}%)`,
                    fillStyle: data.datasets[0].backgroundColor[i],
                    strokeStyle: data.datasets[0].borderColor,
                    lineWidth: 1,
                    index: i
                  }));
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${fmt(context.raw)}/mo`;
                }
              }
            }
          }
        }
      });

      // Monthly Spending Trend Bar Chart
      const trendCtx = document.getElementById('spendingTrendChart').getContext('2d');
      if (spendingTrendChart) spendingTrendChart.destroy();
      
      // Calculate average for reference line
      const avgSpending = data.summary.monthlyAvg;
      
      spendingTrendChart = new Chart(trendCtx, {
        type: 'bar',
        data: {
          labels: data.monthlyTotals.map(m => m.month),
          datasets: [
            {
              label: 'Monthly Spending',
              data: data.monthlyTotals.map(m => m.total),
              backgroundColor: data.monthlyTotals.map((m, i) => 
                i === data.monthlyTotals.length - 1 ? 'rgba(236, 72, 153, 0.3)' : 'rgba(236, 72, 153, 0.6)'
              ),
              borderColor: data.monthlyTotals.map((m, i) => 
                i === data.monthlyTotals.length - 1 ? 'rgba(236, 72, 153, 0.5)' : '#ec4899'
              ),
              borderWidth: 1,
              borderRadius: 4
            },
            {
              label: 'Average',
              data: data.monthlyTotals.map(() => avgSpending),
              type: 'line',
              borderColor: '#64748b',
              borderDash: [5, 5],
              borderWidth: 2,
              pointRadius: 0,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  if (context.datasetIndex === 1) return `Avg: ${fmt(context.raw)}`;
                  return `Spent: ${fmt(context.raw)}`;
                },
                afterLabel: function(context) {
                  if (context.datasetIndex === 0 && context.dataIndex === data.monthlyTotals.length - 1) {
                    return '(partial month)';
                  }
                  return '';
                }
              }
            }
          },
          scales: {
            x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 11 } } },
            y: { 
              grid: { color: 'rgba(100,116,139,0.2)' }, 
              ticks: { color: '#64748b', font: { size: 10 }, callback: v => `$${(v/1000).toFixed(1)}K` },
              beginAtZero: true
            }
          }
        }
      });

      // Top Vendors Table
      const vendorTable = document.getElementById('topVendorsTable');
      vendorTable.innerHTML = data.topVendors.map(v => `
        <tr class="border-b border-slate-700/30 last:border-0">
          <td class="py-2 pr-4">${v.name}</td>
          <td class="py-2 px-2 text-right text-pink-400">${fmt(v.total)}</td>
          <td class="py-2 px-2 text-right text-slate-400">${v.txns}</td>
          <td class="py-2 pl-2 text-right">${fmt(v.avg)}</td>
        </tr>
      `).join('');

      // Detailed Categories Table
      const catTable = document.getElementById('detailedCategoriesTable');
      catTable.innerHTML = data.detailedCategories.map(c => `
        <tr class="border-b border-slate-700/30 last:border-0">
          <td class="py-2 pr-4">${c.name}</td>
          <td class="py-2 px-2 text-right text-pink-400">${fmt(c.avg)}</td>
          <td class="py-2 pl-2 text-right text-slate-400">${fmt(c.total)}</td>
        </tr>
      `).join('');
    };

    const showLoading = show => {
      document.getElementById('loading').classList.toggle('hidden', !show);
      document.getElementById('refreshIcon').classList.toggle('animate-spin', show);
    };

    const showError = (msg) => {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('content').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('errorMsg').textContent = msg;
    };

    const showContent = () => {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.add('hidden');
      document.getElementById('content').classList.remove('hidden');
    };

    // Retirement Projection Model
    let retireChart = null;
    
    const RETIRE_CONFIG = {
      btcRate: 0.10,
      iraRate: 0.08,
      homeRate: 0.05,
      variableInflationRate: 0.06, // Only on non-mortgage expenses
      jonSalaryGrowthRate: 0.03,
      lenoraSalaryGrowthRate: 0.05,
      
      // Tax-adjusted portfolio rule
      // Assume 15% effective tax rate on blended withdrawals (mix of traditional IRA + tax-free sources)
      // Base 30x expenses / 0.85 = ~35x to account for taxes
      portfolioMultiple: 35,
      
      startYear: 2026,
      
      // Expenses breakdown (MIT Living Wage for Santa Rosa family of 4)
      totalBaseExpenses: 118301,
      fixedMortgagePayment: 38268, // $3,189/mo x 12, locked at 3.25%, doesn't inflate
      baseVariableExpenses: 80033, // $118,301 - $38,268 = variable portion (inflates at 6%)
      
      // Starting asset values (Jan 2026) - broken out clearly
      startHomeValue: 1191100,
      startIRA: 1047848,
      startBTC: 705041,
      startCars: 27555,
      startCash: 10000,
      
      // Starting liabilities
      startMortgage: 635702,
      startHELOC: 28245, // Paid off in Sept 2026
      startStudentLoans: 250000, // Lenora's - forgiven in 2035 (year 9)
      studentLoanForgivenessYear: 9, // Year 9 = 2035
      
      // Monthly savings (year 1)
      baseBTCMonthly: 3000, // Jon's BTC purchases - grows at Jon's rate
      baseJonIRAMonthly: 1088.17, // Jon's IRA + match
      baseLenIRAMonthly: 1088.17, // Lenora's IRA + match
      
      // Kaiser Pension - Conservative lower-end estimate
      // Based on Jan 2026 spreadsheet: 25yr vesting, retire at 50, benefits start at 65
      // Using $3,000/mo as conservative floor below the $3,344 shown for 12yr vesting at 65
      pensionMonthly: 3000,
      pensionAnnual: 36000, // $3,000 x 12
      pensionStartAge: 65,
      currentAge: 37, // As of Jan 2026
      pensionStartYear: 2054, // Age 65 = 2026 + (65-37) = 2054
      
      // Mortgage amortization (3.25%, 30yr, starting year 7)
      getMortgagePrincipal: function(year) {
        const yearPrincipals = [1501, 1551, 1603, 1656, 1712, 1769, 1828, 1889, 1953, 2018, 2085, 2154, 2225, 2299, 2375, 2454, 2535, 2619, 2706, 2795];
        return yearPrincipals[Math.min(year - 1, yearPrincipals.length - 1)];
      }
    };

    const calculateRetirement = (liveNW) => {
      const cfg = RETIRE_CONFIG;
      const projection = [];
      
      // Use live NW if provided, otherwise calculate from components
      let homeValue = cfg.startHomeValue;
      let mortgageBalance = cfg.startMortgage;
      let helocBalance = cfg.startHELOC;
      let studentLoans = cfg.startStudentLoans;
      let ira = cfg.startIRA;
      let btc = cfg.startBTC;
      let cars = cfg.startCars; // Depreciates
      let cash = cfg.startCash;
      
      // Calculate starting NW from components
      const calcNW = () => homeValue - mortgageBalance - helocBalance - studentLoans + ira + btc + cars + cash;
      
      // If live NW provided, adjust cash to reconcile
      if (liveNW && liveNW > 0) {
        const componentNW = calcNW();
        const diff = liveNW - componentNW;
        cash += diff; // Adjust cash to match live NW
      }
      
      let targetYear = null;
      const startingNW = calcNW();
      
      for (let year = 1; year <= 30; year++) {
        const startNW = calcNW();
        
        // Salary-adjusted monthly savings (BTC + IRA only, mortgage principal is just debt paydown)
        // Jon: 3% salary growth, Lenora: 5% salary growth
        const jonSalaryMultiplier = Math.pow(1 + cfg.jonSalaryGrowthRate, year - 1);
        const lenSalaryMultiplier = Math.pow(1 + cfg.lenoraSalaryGrowthRate, year - 1);
        const btcMonthly = cfg.baseBTCMonthly * jonSalaryMultiplier; // Jon's BTC purchases
        const jonIRAMonthly = cfg.baseJonIRAMonthly * jonSalaryMultiplier;
        const lenIRAMonthly = cfg.baseLenIRAMonthly * lenSalaryMultiplier;
        const iraMonthly = jonIRAMonthly + lenIRAMonthly;
        const mortgagePrincipalMonthly = cfg.getMortgagePrincipal(year);
        
        const annualBTCSavings = btcMonthly * 12;
        const annualIRASavings = iraMonthly * 12;
        const annualMortgagePrincipal = mortgagePrincipalMonthly * 12;
        
        // Check if pension is active this year
        const ageAtYearEnd = cfg.currentAge + year;
        const pensionActive = ageAtYearEnd >= cfg.pensionStartAge;
        
        // Pension adds income once active - goes to cash/investments
        const pensionIncome = pensionActive ? cfg.pensionAnnual : 0;
        
        // Total savings = money going toward building equity (investments + debt paydown)
        // Note: Mortgage principal paydown builds home equity
        const totalAnnualSavings = annualBTCSavings + annualIRASavings + annualMortgagePrincipal;
        
        // Asset appreciation
        const homeAppreciation = homeValue * cfg.homeRate;
        const iraAppreciation = ira * cfg.iraRate;
        const btcAppreciation = btc * cfg.btcRate;
        const carDepreciation = cars * 0.10; // Cars lose 10%/year
        
        // Growth on new contributions (half-year average)
        const iraGrowthOnNew = annualIRASavings * cfg.iraRate * 0.5;
        const btcGrowthOnNew = annualBTCSavings * cfg.btcRate * 0.5;
        
        const totalAppreciation = homeAppreciation + iraAppreciation + btcAppreciation + iraGrowthOnNew + btcGrowthOnNew - carDepreciation;
        
        // Update asset values
        homeValue = homeValue * (1 + cfg.homeRate);
        mortgageBalance = mortgageBalance - annualMortgagePrincipal;
        cars = cars * 0.90; // 10% depreciation
        
        // HELOC paid off at end of Year 1 (from net inflow/savings, not cash reserve)
        if (year === 1 && helocBalance > 0) {
          helocBalance = 0;
        }
        
        // Student loan forgiveness in year 9 (2035)
        if (year === cfg.studentLoanForgivenessYear) {
          studentLoans = 0;
        }
        
        // Pension benefit is modeled via reduced required portfolio (requiredWithPension),
        // not by adding income to assets during accumulation phase
        
        ira = ira + iraAppreciation + annualIRASavings + iraGrowthOnNew;
        btc = btc + btcAppreciation + annualBTCSavings + btcGrowthOnNew;
        
        const endNW = calcNW();
        
        // Expense model: fixed mortgage + inflating variable expenses
        const variableExpenses = cfg.baseVariableExpenses * Math.pow(1 + cfg.variableInflationRate, year);
        const totalExpenses = cfg.fixedMortgagePayment + variableExpenses;
        
        // Tax-adjusted required portfolio (35x instead of 30x)
        const requiredPortfolio = totalExpenses * cfg.portfolioMultiple;
        
        // Pension reduces expenses that need to be covered by portfolio
        // $30K/yr pension = $30K less expenses x 35 = $1.05M less required
        const pensionAdjustedExpenses = pensionActive ? Math.max(0, totalExpenses - cfg.pensionAnnual) : totalExpenses;
        const requiredWithPension = pensionAdjustedExpenses * cfg.portfolioMultiple;
        
        const gap = endNW - requiredPortfolio;
        const gapWithPension = endNW - requiredWithPension;
        
        if (gap >= 0 && !targetYear) {
          targetYear = cfg.startYear + year;
        }
        
        projection.push({
          year,
          calendarYear: cfg.startYear + year,
          startNW,
          totalAnnualSavings,
          totalAppreciation,
          endNW,
          fixedExpenses: cfg.fixedMortgagePayment,
          variableExpenses,
          totalExpenses,
          requiredPortfolio,
          requiredWithPension,
          pensionActive,
          pensionIncome,
          ageAtYearEnd,
          gap,
          gapWithPension,
          // Detailed asset breakdown
          homeValue,
          mortgageBalance,
          homeEquity: homeValue - mortgageBalance,
          ira,
          btc,
          cars,
          cash,
          studentLoans,
          btcMonthly,
          iraMonthly,
          mortgagePrincipalMonthly
        });
      }
      
      return { projection, targetYear, startingNW };
    };

    const toggleRetireSection = (section) => {
      const content = document.getElementById(section + 'Content');
      const chevron = document.getElementById(section + 'Chevron');
      content.classList.toggle('hidden');
      chevron.classList.toggle('rotate-180');
    };

    const renderRetirement = (liveNW) => {
      const { projection, targetYear, startingNW } = calculateRetirement(liveNW);
      const cfg = RETIRE_CONFIG;
      
      // Find target index (first year with positive gap)
      const targetIdx = projection.findIndex(p => p.gap >= 0);
      const target = targetIdx >= 0 ? projection[targetIdx] : projection[projection.length - 1];
      
      // Update main stats - use live NW if available
      const displayNW = liveNW && liveNW > 0 ? liveNW : startingNW;
      document.getElementById('retireCurrentNW').textContent = fmt(displayNW, true);
      document.getElementById('retireTarget').textContent = fmt(target.requiredPortfolio, true);
      document.getElementById('retireYears').textContent = targetIdx >= 0 ? (targetIdx + 1) : '>30';
      document.getElementById('retireTargetYear').textContent = targetYear || '2056+';
      
      // Update target year hero display
      const heroYear = document.getElementById('retireHeroYear');
      if (heroYear) {
        heroYear.textContent = targetYear || '2056+';
        heroYear.classList.add('animate-pulse-once');
      }
      
      // Projection chart with visual distinction
      const ctx = document.getElementById('retireChart').getContext('2d');
      if (retireChart) retireChart.destroy();
      
      // Find where projection crosses into "achieved" territory
      const crossoverIdx = projection.findIndex(p => p.gap >= 0);
      
      retireChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: projection.map(p => p.calendarYear),
          datasets: [
            {
              label: 'Projected Net Worth',
              data: projection.map(p => p.endNW),
              borderColor: '#14b8a6',
              backgroundColor: 'rgba(20, 184, 166, 0.1)',
              fill: true,
              tension: 0.3,
              pointRadius: projection.map((p, i) => i === crossoverIdx ? 8 : 3),
              pointBackgroundColor: projection.map((p, i) => {
                if (i === crossoverIdx) return '#10b981'; // Target year = bright green
                return p.gap >= 0 ? '#10b981' : '#14b8a6';
              }),
              pointBorderColor: projection.map((p, i) => i === crossoverIdx ? '#fff' : 'transparent'),
              pointBorderWidth: projection.map((p, i) => i === crossoverIdx ? 3 : 0)
            },
            {
              label: 'Required Portfolio (35x)',
              data: projection.map(p => p.requiredPortfolio),
              borderColor: '#f43f5e',
              backgroundColor: 'transparent',
              borderDash: [5, 5],
              tension: 0.3,
              pointRadius: 0
            },
            {
              label: 'Required w/Pension',
              data: projection.map(p => p.requiredWithPension),
              borderColor: '#818cf8',
              backgroundColor: 'transparent',
              borderDash: [3, 3],
              tension: 0.3,
              pointRadius: projection.map(p => p.pensionActive ? 4 : 0),
              pointBackgroundColor: '#818cf8'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + fmt(context.raw, true);
                },
                afterBody: function(context) {
                  const idx = context[0].dataIndex;
                  const p = projection[idx];
                  const notes = [];
                  if (p.pensionActive) {
                    notes.push('', '💰 Pension active ($2.5K/mo)');
                  }
                  if (p.calendarYear === 2035) {
                    notes.push('', '🎉 Student loans forgiven!');
                  }
                  if (p.gap >= 0 && idx === crossoverIdx) {
                    notes.push('', '✓ Target reached!');
                  }
                  if (p.gapWithPension >= 0 && p.gap < 0) {
                    notes.push('', '✓ Target w/pension!');
                  }
                  return notes;
                }
              }
            }
          },
          scales: {
            x: { 
              grid: { display: false }, 
              ticks: { 
                color: '#64748b', 
                font: { size: 10 },
                callback: function(value, index) {
                  const year = projection[index].calendarYear;
                  if (year === targetYear) return '[TARGET] ' + year;
                  if (year === 2035) return '* ' + year;
                  return year;
                }
              } 
            },
            y: { 
              grid: { color: 'rgba(100,116,139,0.2)' }, 
              ticks: { color: '#64748b', font: { size: 10 }, callback: v => `$${(v/1e6).toFixed(1)}M` }
            }
          }
        }
      });
      
      // Year-by-year table with student loan forgiveness and pension highlights
      const yearTable = document.getElementById('yearByYearTable');
      yearTable.innerHTML = projection.map(p => `
        <tr class="${p.gap >= 0 ? 'bg-emerald-500/10' : ''} ${p.calendarYear === 2035 ? 'bg-amber-500/10' : ''} ${p.pensionActive && !projection[p.year - 2]?.pensionActive ? 'bg-indigo-500/10' : ''}">
          <td class="py-2 pr-4 font-medium">
            ${p.calendarYear}
            ${p.calendarYear === 2035 ? '<span class="text-amber-400 text-xs ml-1">loans forgiven</span>' : ''}
            ${p.pensionActive && !projection[p.year - 2]?.pensionActive ? '<span class="text-indigo-400 text-xs ml-1">pension starts</span>' : ''}
            ${p.gap >= 0 && projection[p.year - 2]?.gap < 0 ? '<span class="text-emerald-400 text-xs ml-1">🎯 target</span>' : ''}
          </td>
          <td class="py-2 px-2 text-right">${fmt(p.startNW, true)}</td>
          <td class="py-2 px-2 text-right text-emerald-400">${fmt(p.totalAnnualSavings, true)}</td>
          <td class="py-2 px-2 text-right text-cyan-400">${fmt(p.totalAppreciation, true)}</td>
          <td class="py-2 px-2 text-right font-medium">${fmt(p.endNW, true)}</td>
          <td class="py-2 px-2 text-right text-slate-400">${fmt(p.totalExpenses, true)}${p.pensionActive ? '<span class="text-indigo-400 text-xs ml-1">-$40K</span>' : ''}</td>
          <td class="py-2 px-2 text-right ${p.pensionActive ? 'text-indigo-400' : 'text-rose-400'}">${fmt(p.pensionActive ? p.requiredWithPension : p.requiredPortfolio, true)}</td>
          <td class="py-2 pl-2 text-right ${(p.pensionActive ? p.gapWithPension : p.gap) >= 0 ? 'text-emerald-400' : 'text-rose-400'}">${(p.pensionActive ? p.gapWithPension : p.gap) >= 0 ? '+' : ''}${fmt(p.pensionActive ? p.gapWithPension : p.gap, true)}</td>
        </tr>
      `).join('');
      
      // Savings table
      const savingsTable = document.getElementById('savingsTable');
      savingsTable.innerHTML = projection.map(p => `
        <tr>
          <td class="py-2 pr-4 font-medium">${p.calendarYear}</td>
          <td class="py-2 px-2 text-right text-orange-400">$${Math.round(p.btcMonthly).toLocaleString()}</td>
          <td class="py-2 px-2 text-right text-violet-400">$${Math.round(p.iraMonthly).toLocaleString()}</td>
          <td class="py-2 px-2 text-right">${fmt(p.btcMonthly + p.iraMonthly)}</td>
          <td class="py-2 pl-2 text-right font-medium">${fmt(p.totalAnnualSavings, true)}</td>
        </tr>
      `).join('');
      
      // Asset growth table with full breakdown
      const assetTable = document.getElementById('assetGrowthTable');
      const startRow = {
        year: cfg.startYear,
        homeEquity: cfg.startHomeValue - cfg.startMortgage - cfg.startHELOC,
        ira: cfg.startIRA,
        btc: cfg.startBTC,
        cars: cfg.startCars,
        cash: cfg.startCash,
        studentLoans: cfg.startStudentLoans,
        endNW: startingNW
      };
      
      assetTable.innerHTML = [startRow, ...projection].map(p => `
        <tr class="${p.studentLoans === 0 && p.year !== cfg.startYear ? 'bg-amber-500/5' : ''}">
          <td class="py-2 pr-4 font-medium">${p.year || p.calendarYear}</td>
          <td class="py-2 px-2 text-right text-blue-400">${fmt(p.homeEquity, true)}</td>
          <td class="py-2 px-2 text-right text-violet-400">${fmt(p.ira, true)}</td>
          <td class="py-2 px-2 text-right text-orange-400">${fmt(p.btc, true)}</td>
          <td class="py-2 px-2 text-right text-slate-400">${fmt((p.cars || 0) + (p.cash || 0), true)}</td>
          <td class="py-2 px-2 text-right ${p.studentLoans > 0 ? 'text-rose-400' : 'text-emerald-400'}">${p.studentLoans > 0 ? '-' + fmt(p.studentLoans, true) : '$0'}</td>
          <td class="py-2 pl-2 text-right font-medium">${fmt(p.endNW, true)}</td>
        </tr>
      `).join('');
    };

    async function loadData() {
      showLoading(true);
      let nwData = null, cfData = null, nwErr = null, cfErr = null;

      try {
        const r = await fetch(API.netWorth);
        nwData = await r.json();
        document.getElementById('nwStatus').className = 'w-3 h-3 rounded-full bg-emerald-400';
      } catch (e) {
        nwErr = e.message;
        document.getElementById('nwStatus').className = 'w-3 h-3 rounded-full bg-rose-400';
      }

      try {
        const r = await fetch(API.cashFlow);
        cfData = await r.json();
        document.getElementById('cfStatus').className = 'w-3 h-3 rounded-full bg-emerald-400';
      } catch (e) {
        cfErr = e.message;
        document.getElementById('cfStatus').className = 'w-3 h-3 rounded-full bg-rose-400';
      }

      showLoading(false);
      document.getElementById('fetchTime').textContent = new Date().toLocaleTimeString();

      if (!nwData && !cfData) {
        showError(nwErr || cfErr || 'Unknown error');
        return;
      }

      showContent();

      if (nwData) {
        const nw = parseNW(nwData);
        if (nw) {
          renderNW(nw);
          // Use live-adjusted NW for retirement (set by renderNW)
          renderRetirement(nw.liveNwUSD || nw.cur.nwUSD);
        }
      }

      if (cfData) {
        const cf = parseCF(cfData);
        if (cf) renderCF(cf);
      }

      // Render spending analysis (static data from xlsx)
      renderSpending();
    }

    // Load market data first to get live BTC price, then load sheet data
    async function init() {
      await loadMarketData();
      loadData();
    }
    init();
  </script>

</body>
</html>
